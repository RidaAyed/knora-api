<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../cloud">
<title>Gravsearch Design · Knora Documentation</title>
<link rel="stylesheet" href="../../../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../../../assets/stylesheets/application-palette.792431c1.css">
<link rel="stylesheet" href="../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../lib/prettify/prettify.css">
<script src="../../../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
data-md-color-primary="blue"
data-md-color-accent="yellow"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../index.html" title="Knora Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">cloud</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Knora Documentation
</span>
<span class="md-header-nav__topic">
Gravsearch Design
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">cloud</i>
</span>
<a href="../../../index.html" title="Knora Documentation">
Knora Documentation
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
<ul>
  <li><a href="../../../01-introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../../01-introduction/what-is-knora.html" class="page">What Is Knora?</a></li>
    <li><a href="../../../01-introduction/data-formats.html" class="page">Data Formats in Knora</a></li>
    <li><a href="../../../01-introduction/standoff-rdf.html" class="page">Standoff/RDF Text Markup</a></li>
    <li><a href="../../../01-introduction/example-project.html" class="page">An Example Project</a></li>
  </ul></li>
  <li><a href="../../../02-knora-ontologies/index.html" class="page">Knora Ontologies</a>
  <ul>
    <li><a href="../../../02-knora-ontologies/introduction.html" class="page">Introduction</a></li>
    <li><a href="../../../02-knora-ontologies/knora-base.html" class="page">The Knora Base Ontology</a></li>
    <li><a href="../../../02-knora-ontologies/salsah-gui.html" class="page">The SALSAH GUI Ontology</a></li>
  </ul></li>
  <li><a href="../../../03-apis/index.html" class="page">The Knora APIs</a>
  <ul>
    <li><a href="../../../03-apis/api-v1/index.html" class="page">Knora API v1</a></li>
    <li><a href="../../../03-apis/api-v2/index.html" class="page">Knora API v2</a></li>
    <li><a href="../../../03-apis/api-admin/index.html" class="page">Knora Admin API</a></li>
  </ul></li>
  <li><a href="../../../04-deployment/index.html" class="page">Deploying Knora</a>
  <ul>
    <li><a href="../../../04-deployment/getting-started.html" class="page">Getting Started with Knora</a></li>
    <li><a href="../../../04-deployment/configuration.html" class="page">Configuration</a></li>
  </ul></li>
  <li><a href="../../../05-internals/index.html" class="page">Knora Internals</a>
  <ul>
    <li><a href="../../../05-internals/design/index.html" class="page">Design</a></li>
    <li><a href="../../../05-internals/development/index.html" class="page">Development</a></li>
  </ul></li>
  <li><a href="../../../06-salsah/index.html" class="page">The SALSAH 1 GUI</a></li>
  <li><a href="../../../07-sipi/index.html" class="page">The Sipi Media Server</a>
  <ul>
    <li><a href="../../../07-sipi/setup-sipi-for-knora.html" class="page">Setting Up Sipi for Knora</a></li>
    <li><a href="../../../07-sipi/sipi-and-knora.html" class="page">Interaction Between Sipi and Knora</a></li>
  </ul></li>
  <li><a href="../../../faq.html" class="page">Frequently Asked Questions</a></li>
  <li><a href="../../../00-release-notes/index.html" class="page">Release Notes</a>
  <ul>
    <li><a href="../../../00-release-notes/v1.1.0.html" class="page">v1.1.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.2.0.html" class="page">v1.2.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.3.0.html" class="page">v1.3.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.4.0.html" class="page">v1.4.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.5.0.html" class="page">v1.5.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.6.0.html" class="page">v1.6.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.7.0.html" class="page">v1.7.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v2.x.x.html" class="page">v2.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v3.x.x.html" class="page">v3.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v4.x.x.html" class="page">v4.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v5.x.x.html" class="page">v5.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/next.html" class="page">Release Notes for Next Release</a></li>
    <li><a href="../../../00-release-notes/migration.html" class="page">Migration Notes</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../../05-internals/design/api-v2/gravsearch.html#gravsearch-design" class="header">Gravsearch Design</a>
  <ul>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#gravsearch-package" class="header">Gravsearch Package</a></li>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#type-inspection" class="header">Type Inspection</a></li>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#transformation-of-a-gravsearch-query" class="header">Transformation of a Gravsearch Query</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 5.0.0
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../../05-internals/design/api-v2/gravsearch.html#gravsearch-design" class="header">Gravsearch Design</a>
  <ul>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#gravsearch-package" class="header">Gravsearch Package</a></li>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#type-inspection" class="header">Type Inspection</a></li>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#transformation-of-a-gravsearch-query" class="header">Transformation of a Gravsearch Query</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<!---
Copyright © 2015-2019 the contributors (see Contributors.md).

This file is part of Knora.

Knora is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Knora is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with Knora.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1><a href="#gravsearch-design" name="gravsearch-design" class="anchor"><span class="anchor-link"></span></a>Gravsearch Design</h1>
<div class="toc ">
<ul>
  <li><a href="../../../05-internals/design/api-v2/gravsearch.html#gravsearch-package" class="header">Gravsearch Package</a></li>
  <li><a href="../../../05-internals/design/api-v2/gravsearch.html#type-inspection" class="header">Type Inspection</a>
  <ul>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#identifying-typeable-entities" class="header">Identifying Typeable Entities</a></li>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#the-type-inspection-pipeline" class="header">The Type Inspection Pipeline</a>
    <ul>
      <li><a href="../../../05-internals/design/api-v2/gravsearch.html#annotationreadinggravsearchtypeinspector" class="header">AnnotationReadingGravsearchTypeInspector</a></li>
      <li><a href="../../../05-internals/design/api-v2/gravsearch.html#inferringgravsearchtypeinspector" class="header">InferringGravsearchTypeInspector</a></li>
    </ul></li>
  </ul></li>
  <li><a href="../../../05-internals/design/api-v2/gravsearch.html#transformation-of-a-gravsearch-query" class="header">Transformation of a Gravsearch Query</a>
  <ul>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#query-transformers" class="header">Query Transformers</a></li>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#prequery" class="header">Prequery</a></li>
    <li><a href="../../../05-internals/design/api-v2/gravsearch.html#main-query" class="header">Main Query</a>
    <ul>
      <li><a href="../../../05-internals/design/api-v2/gravsearch.html#generating-the-main-query" class="header">Generating the Main Query</a></li>
      <li><a href="../../../05-internals/design/api-v2/gravsearch.html#processing-the-main-querys-results" class="header">Processing the Main Query&rsquo;s results</a></li>
    </ul></li>
  </ul></li>
</ul>
</div>
<h2><a href="#gravsearch-package" name="gravsearch-package" class="anchor"><span class="anchor-link"></span></a>Gravsearch Package</h2>
<p>The classes that process Gravsearch queries and results can be found in <code>org.knora.webapi.responders.v2.search.gravsearch</code>.</p>
<h2><a href="#type-inspection" name="type-inspection" class="anchor"><span class="anchor-link"></span></a>Type Inspection</h2>
<p>The code that converts Gravserch queries into SPARQL queries, and processes the query results, needs to know the types of the entities that are used in the input query. As explained in <a href="../../../03-apis/api-v2/query-language.html#type-inference">Type Inference</a>, these types can be inferred, or they can be specified in the query using type annotations.</p>
<p>Type inspection is implemented in the package <code>org.knora.webapi.responders.v2.search.gravsearch.types</code>. The entry point to this package is <code>GravsearchTypeInspectionRunner</code>, which is instantiated by <code>SearchResponderV2</code>. The result of type inspection is a <code>GravsearchTypeInspectionResult</code>, in which each typeable entity in the input query is associated with a <code>GravsearchEntityTypeInfo</code>, which can be either:</p>
<ul>
  <li>A <code>PropertyTypeInfo</code>, which specifies the type of object that a property is expected to have.</li>
  <li>A <code>NonPropertyTypeInfo</code>, which specifies the type of a variable, or the type of an IRI representing a resource or value.</li>
</ul>
<h3><a href="#identifying-typeable-entities" name="identifying-typeable-entities" class="anchor"><span class="anchor-link"></span></a>Identifying Typeable Entities</h3>
<p>After parsing a Gravsearch query, <code>SearchResponderV2</code> calls <code>GravsearchTypeInspectionRunner.inspectTypes</code>, passing the WHERE clause of the input query. This method first identifies the entities whose types need to be determined. Each of these entities is represented as a <code>TypeableEntity</code>. To do this, <code>GravsearchTypeInspectionRunner</code> uses <code>QueryTraverser</code> to traverse the WHERE clause, collecting typeable entities in a visitor called <code>TypeableEntityCollectingWhereVisitor</code>. The entities that are considered to need type information are:</p>
<ul>
  <li>All variables.</li>
  <li>All IRIs except for those that represent type annotations or types.</li>
</ul>
<h3><a href="#the-type-inspection-pipeline" name="the-type-inspection-pipeline" class="anchor"><span class="anchor-link"></span></a>The Type Inspection Pipeline</h3>
<p><code>GravsearchTypeInspectionRunner</code> contains a pipeline of type inspectors, each of which extends <code>GravsearchTypeInspector</code>. There are two type inspectors in the pipeline:</p>
<ul>
  <li><code>AnnotationReadingGravsearchTypeInspector</code>: reads  <a href="../../../03-apis/api-v2/query-language.html#type-annotations">type annotations</a> included in a Gravsearch query.</li>
  <li><code>InferringGravsearchTypeInspector</code>: infers the types of entities from the context in which they are used, as well  as from ontology information that it requests from <code>OntologyResponderV2</code>.</li>
</ul>
<p>Each type inspector takes as input, and returns as output, an <code>IntermediateTypeInspectionResult</code>, which associates each <code>TypeableEntity</code> with zero or more types. Initially, each <code>TypeableEntity</code> has no types. Each type inspector adds whatever types it finds for each entity. At the end of the pipeline, each entity should have exactly one type. If not, that&rsquo;s an error, with two possible causes:</p>
<ul>
  <li>An entity&rsquo;s type could not be determined. The client must add a type annotation to make the query work.</li>
  <li>An entity appears to have more than one type, because the query used the entity inconsistently.</li>
</ul>
<p>If there are no errors, <code>GravsearchTypeInspectionRunner</code> converts the pipeline&rsquo;s output to a <code>GravsearchTypeInspectionResult</code>, in which each entity is associated with exactly one type.</p>
<h4><a href="#annotationreadinggravsearchtypeinspector" name="annotationreadinggravsearchtypeinspector" class="anchor"><span class="anchor-link"></span></a>AnnotationReadingGravsearchTypeInspector</h4>
<p>This inspector uses <code>QueryTraverser</code> to traverse the WHERE clause, collecting type annotations in a visitor called <code>AnnotationCollectingWhereVisitor</code>. It then converts each annotation to a <code>GravsearchEntityTypeInfo</code>.</p>
<h4><a href="#inferringgravsearchtypeinspector" name="inferringgravsearchtypeinspector" class="anchor"><span class="anchor-link"></span></a>InferringGravsearchTypeInspector</h4>
<p>This inspector first uses <code>QueryTraverser</code> to traverse the WHERE clause, assembling an index of usage information about typeable entities in a visitor called <code>UsageIndexCollectingWhereVisitor</code>. The <code>UsageIndex</code> contains, for example, an index of all the entities that are used as subjects, predicates, or objects, along with the statements in which they are used. It also contains sets of all the Knora class and property IRIs that are used in the WHERE clause. <code>InferringGravsearchTypeInspector</code> then asks <code>OntologyResponderV2</code> for information about those classes and properties, as well as about the classes that are subject types or object types of those properties.</p>
<p>Next, the inspector runs inference rules (which extend <code>InferenceRule</code>) on each <code>TypeableEntity</code>. Each rule takes as input a <code>TypeableEntity</code>, the usage index, the ontology information, and the <code>IntermediateTypeInspectionResult</code>, and returns a new <code>IntermediateTypeInspectionResult</code>. For example, <code>TypeOfObjectFromPropertyRule</code> infers an entity&rsquo;s type if the entity is used as the object of a statement and the predicate&rsquo;s <code>knora-api:objectType</code> is known.</p>
<p>The inference rules are run repeatedly, because the output of one rule may allow another rule to infer additional information. There are two pipelines of rules: a pipeline for the first iteration of type inference, and a pipeline for subsequent iterations. This is because some rules can return additional information if they are run more than once on the same entity, while others cannot.</p>
<p>The number of iterations is limited to <code>InferringGravsearchTypeInspector.MAX_ITERATIONS</code>, but in practice two iterations are sufficient for most realistic queries, and it is difficult to design a query that requires more than six iterations.</p>
<h2><a href="#transformation-of-a-gravsearch-query" name="transformation-of-a-gravsearch-query" class="anchor"><span class="anchor-link"></span></a>Transformation of a Gravsearch Query</h2>
<p>A Gravsearch query submitted by the client is parsed by <code>GravsearchParser</code> and preprocessed by <code>GravsearchTypeInspector</code> to get type information about the elements used in the query (resources, values, properties etc.) and do some basic sanity checks.</p>
<p>In <code>SearchResponderV2</code>, two queries are generated from a given Gravsearch query: a prequery and a main query.</p>
<h3><a href="#query-transformers" name="query-transformers" class="anchor"><span class="anchor-link"></span></a>Query Transformers</h3>
<p>The Gravsearch query is passed to <code>QueryTraverser</code> along with a query transformer. Query transformers are classes that implement traits supported by <code>QueryTraverser</code>:</p>
<ul>
  <li><code>WhereTransformer</code>: instructions how to convert statements in the Where clause of a SPARQL query (to generate the prequery&rsquo;s Where clause).</li>
  <li><code>ConstructToSelectTransformer</code> (extends <code>WhereTransformer</code>): instructions how to turn a Construct query into a Select query (converts a Gravsearch query into a prequery)</li>
  <li><code>SelectToSelectTransformer</code> (extends <code>WhereTransformer</code>): instructions how to turn a triplestore independent Select query into a triplestore dependent Select query (implementation of inference).</li>
  <li><code>ConstructToConstructTransformer</code> (extends <code>WhereTransformer</code>): instructions how to turn a triplestore independent Construct query into a triplestore dependent Construct query (implementation of inference).</li>
</ul>
<p>The traits listed above define methods that are implemented in the transformer classes and called by <code>QueryTraverser</code> to perform SPARQL to SPARQL conversions. When iterating over the statements of the input query, the transformer class&rsquo;s transformation methods are called to perform the conversion.</p>
<h3><a href="#prequery" name="prequery" class="anchor"><span class="anchor-link"></span></a>Prequery</h3>
<p>The purpose of the prequery is to get an ordered collection of results representing only the IRIs of one page of matching resources and values. Sort criteria can be submitted by the user, but the result is always deterministic also without sort criteria. This is necessary to support paging. A prequery is a SPARQL SELECT query.</p>
<p>The classes involved in generating prequeries can be found in <code>org.knora.webapi.responders.v2.search.gravsearch.prequery</code>.</p>
<p>If the client submits a count query, the prequery returns the overall number of hits, but not the results themselves.</p>
<p>In a first step, the Gravsearch query&rsquo;s WHERE clause is transformed and the prequery (SELECT and WHERE clause) is generated from this result. The transformation of the Gravsearch query&rsquo;s WHERE clause relies on the implementation of the abstract class <code>AbstractPrequeryGenerator</code>.</p>
<p><code>AbstractPrequeryGenerator</code> contains members whose state is changed during the iteration over the statements of the input query. They can then by used to create the converted query.</p>
<ul>
  <li><code>mainResourceVariable: Option[QueryVariable]</code>: SPARQL variable representing the main resource of the input query. Present in the prequery&rsquo;s SELECT clause.</li>
  <li><code>dependentResourceVariables: mutable.Set[QueryVariable]</code>: a set of SPARQL variables representing dependent resources in the input query. Used in an aggregation function in the prequery&rsquo;s SELECT clause (see below).</li>
  <li><code>dependentResourceVariablesGroupConcat: Set[QueryVariable]</code>: a set of SPARQL variables representing an aggregation of dependent resources. Present in the prequery&rsquo;s SELECT clause.</li>
  <li><code>valueObjectVariables: mutable.Set[QueryVariable]</code>: a set of SPARQL variables representing value objects. Used in an aggregation function in the prequery&rsquo;s SELECT clause (see below).</li>
  <li><code>valueObjectVarsGroupConcat: Set[QueryVariable]</code>: a set of SPARQL variables representing an aggregation of value objects. Present in the prequery&rsquo;s SELECT clause.</li>
</ul>
<p>The variables mentioned above are present in the prequery&rsquo;s result rows because they are part of the prequery&rsquo;s SELECT clause.</p>
<p>The following example illustrates the handling of variables. The following Gravsearch query looks for pages with a sequence number of 10 that are part of a book:</p>
<pre class="prettyprint"><code class="language-sparql">PREFIX incunabula: &lt;http://0.0.0.0:3333/ontology/0803/incunabula/simple/v2#&gt;
PREFIX knora-api: &lt;http://api.knora.org/ontology/knora-api/simple/v2#&gt;

    CONSTRUCT {
        ?page knora-api:isMainResource true .

        ?page knora-api:isPartOf ?book .

        ?page incunabula:seqnum ?seqnum .
    } WHERE {

        ?page a incunabula:page .

        ?page knora-api:isPartOf ?book .

        ?book a incunabula:book .

        ?page incunabula:seqnum ?seqnum .

        FILTER(?seqnum = 10)

    }
</code></pre>
<p>The prequery&rsquo;s SELECT clause is built using the member variables defined in <code>AbstractPrequeryGenerator</code>. State of member variables after transformation of the input query into the prequery:</p>
<ul>
  <li><code>mainResourceVariable</code>: <code>QueryVariable(page)</code></li>
  <li><code>dependentResourceVariables</code>: <code>Set(QueryVariable(book))</code></li>
  <li><code>dependentResourceVariablesGroupConcat</code>: <code>Set(QueryVariable(book__Concat))</code></li>
  <li><code>valueObjectVariables</code>: <code>Set(QueryVariable(book__LinkValue), QueryVariable(seqnum))</code>: <code>?book</code> represents the dependent resource and <code>?book__LinkValue</code> the link value connecting <code>?page</code> and <code>?book</code>.</li>
  <li><code>valueObjectVariablesGroupConcat</code>: <code>Set(QueryVariable(seqnum__Concat), QueryVariable(book__LinkValue__Concat))</code></li>
</ul>
<p>The resulting SELECT clause of the prequery looks as follows:</p>
<pre class="prettyprint"><code class="language-sparql">SELECT DISTINCT
    ?page
    (GROUP_CONCAT(DISTINCT(?book); SEPARATOR=&#39;&#39;) AS ?book__Concat)
    (GROUP_CONCAT(DISTINCT(?seqnum); SEPARATOR=&#39;&#39;) AS ?seqnum__Concat)
    (GROUP_CONCAT(DISTINCT(?book__LinkValue); SEPARATOR=&#39;&#39;) AS ?book__LinkValue__Concat)
    WHERE {...}
    GROUP BY ?page
    ORDER BY ASC(?page)
    LIMIT 25
</code></pre>
<p><code>?page</code> represents the main resource. When accessing the prequery&rsquo;s result rows, <code>?page</code> contains the Iri of the main resource. The prequery&rsquo;s results are grouped by the main resource so that there is exactly one result row per matching main resource. <code>?page</code> is also used as a sort criterion although none has been defined in the input query. This is necessary to make paging work: results always have to be returned in the same order (the prequery is always deterministic). Like this, results can be fetched page by page using LIMIT and OFFSET.</p>
<p>Grouping by main resource requires other results to be aggregated using the function <code>GROUP_CONCAT</code>. <code>?book</code> is used as an argument of the aggregation function. The aggregation&rsquo;s result is accessible in the prequery&rsquo;s result rows as <code>?book__Concat</code>. The variable <code>?book</code> is bound to an Iri. Since more than one Iri could be bound to a variable representing a dependent resource, the results have to be aggregated. <code>GROUP_CONCAT</code> takes two arguments: a collection of strings (Iris in our use case) and a separator. When accessing <code>?book__Concat</code> in the prequery&rsquo;s results containing the Iris of dependent resources, the string has to be split with the separator used in the aggregation function. The result is a collection of Iris representing dependent resources. The same logic applies to value objects.</p>
<h3><a href="#main-query" name="main-query" class="anchor"><span class="anchor-link"></span></a>Main Query</h3>
<p>The purpose of the main query is to get all requested information about the main resource, dependent resources, and value objects. The Iris of those resources and value objects were returned by the prequery. Since the prequery only returns resources and value objects matching the input query&rsquo;s criteria, the main query can specifically ask for more detailed information on these resources and values without having to reconsider these criteria.</p>
<h4><a href="#generating-the-main-query" name="generating-the-main-query" class="anchor"><span class="anchor-link"></span></a>Generating the Main Query</h4>
<p>The classes involved in generating prequeries can be found in <code>org.knora.webapi.responders.v2.search.gravsearch.mainquery</code>.</p>
<p>The main query is a SPARQL CONSTRUCT query. Its generation is handled by the method <code>GravsearchMainQueryGenerator.createMainQuery</code>. It takes three arguments: <code>mainResourceIris: Set[IriRef], dependentResourceIris: Set[IriRef], valueObjectIris: Set[IRI]</code>. From the given Iris, statements are generated that ask for complete information on <em>exactly</em> these resources and values. For any given resource Iri, only the values present in <code>valueObjectIris</code> are to be queried. This is achieved by using SPARQL&rsquo;s <code>VALUES</code> expression for the main resource and dependent resources as well as for values.</p>
<h4><a href="#processing-the-main-querys-results" name="processing-the-main-querys-results" class="anchor"><span class="anchor-link"></span></a>Processing the Main Query&rsquo;s results</h4>
<p>When processing the main query&rsquo;s results, permissions are checked and resources and values that the user did not explicitly ask for in the input query are filtered out. This is implemented in <code>MainQueryResultProcessor</code>.</p>
<p>The method <code>getMainQueryResultsWithFullGraphPattern</code> takes the main query&rsquo;s results as an input and makes sure that the client has sufficient permissions on the results. A main resource and its dependent resources and values are only returned if the user has view permissions on all the resources and value objects present in the main query. Otherwise the method suppresses the main resource. To do the permission checking, the results of the main query are passed to <code>ConstructResponseUtilV2</code> which transforms a <code>SparqlConstructResponse</code> (a set of RDF triples) into a structure organized by main resource Iris. In this structure, dependent resources and values are nested can be accessed via their main resource. <code>SparqlConstructResponse</code> suppresses all resources and values the user has insufficient permissions on. For each main resource, a check is performed for the presence of all resources and values after permission checking.</p>
<p>The method <code>getRequestedValuesFromResultsWithFullGraphPattern</code> filters out those resources and values that the user does not want to be returned by the query. All the resources and values not present in the input query&rsquo;s CONSTRUCT clause are filtered out. This only happens after permission checking.</p>
<p>The main resources that have been filtered out due to insufficient permissions are represented by the placeholder <code>ForbiddenResource</code>. This placeholder stands for a main resource that cannot be returned, nevertheless it informs the client that such a resource exists. This is necessary for a consistent behaviour when doing paging.</p>
</div>
<div>
<a href="https://github.com/dhlab-basel/Knora/tree/master/docs/src/paradox/05-internals/design/api-v2/gravsearch.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
5.0.0
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../05-internals/design/api-v2/sipi.html" title="Knora and Sipi" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Knora and Sipi
</span>
</div>
</a>
<a href="../../../05-internals/design/api-v2/ark.html" title="Archival Resource Key (ARK) Identifiers" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Archival Resource Key (ARK) Identifiers
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright 2015-2019 the contributors (see Contributors.md)
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/dhlab-basel" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/dhlabbasel" class="md-footer-social__link fa fa-twitter"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../../../assets/javascripts/application.5165553b.js"></script>
<script src="../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../."}})</script>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
