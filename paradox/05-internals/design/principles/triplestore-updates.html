<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../cloud">
<title>Triplestore Updates · Knora Documentation</title>
<link rel="stylesheet" href="../../../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../../../assets/stylesheets/application-palette.792431c1.css">
<link rel="stylesheet" href="../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../lib/prettify/prettify.css">
<script src="../../../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
data-md-color-primary="blue"
data-md-color-accent="yellow"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../index.html" title="Knora Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">cloud</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Knora Documentation
</span>
<span class="md-header-nav__topic">
Triplestore Updates
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">cloud</i>
</span>
<a href="../../../index.html" title="Knora Documentation">
Knora Documentation
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
<ul>
  <li><a href="../../../01-introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../../01-introduction/what-is-knora.html" class="page">What Is Knora?</a></li>
    <li><a href="../../../01-introduction/data-formats.html" class="page">Data Formats in Knora</a></li>
    <li><a href="../../../01-introduction/standoff-rdf.html" class="page">Standoff/RDF Text Markup</a></li>
    <li><a href="../../../01-introduction/example-project.html" class="page">An Example Project</a></li>
  </ul></li>
  <li><a href="../../../02-knora-ontologies/index.html" class="page">Knora Ontologies</a>
  <ul>
    <li><a href="../../../02-knora-ontologies/introduction.html" class="page">Introduction</a></li>
    <li><a href="../../../02-knora-ontologies/knora-base.html" class="page">The Knora Base Ontology</a></li>
    <li><a href="../../../02-knora-ontologies/salsah-gui.html" class="page">The SALSAH GUI Ontology</a></li>
  </ul></li>
  <li><a href="../../../03-apis/index.html" class="page">The Knora APIs</a>
  <ul>
    <li><a href="../../../03-apis/api-v1/index.html" class="page">Knora API v1</a></li>
    <li><a href="../../../03-apis/api-v2/index.html" class="page">Knora API v2</a></li>
    <li><a href="../../../03-apis/api-admin/index.html" class="page">Knora Admin API</a></li>
  </ul></li>
  <li><a href="../../../04-deployment/index.html" class="page">Deploying Knora</a>
  <ul>
    <li><a href="../../../04-deployment/getting-started.html" class="page">Getting Started with Knora</a></li>
    <li><a href="../../../04-deployment/configuration.html" class="page">Configuration</a></li>
    <li><a href="../../../04-deployment/updates.html" class="page">Updating Repositories When Upgrading Knora</a></li>
  </ul></li>
  <li><a href="../../../05-internals/index.html" class="page">Knora Internals</a>
  <ul>
    <li><a href="../../../05-internals/design/index.html" class="page">Design</a></li>
    <li><a href="../../../05-internals/development/index.html" class="page">Development</a></li>
  </ul></li>
  <li><a href="../../../06-salsah/index.html" class="page">The SALSAH 1 GUI</a></li>
  <li><a href="../../../07-sipi/index.html" class="page">The Sipi Media Server</a>
  <ul>
    <li><a href="../../../07-sipi/setup-sipi-for-knora.html" class="page">Setting Up Sipi for Knora</a></li>
    <li><a href="../../../07-sipi/sipi-and-knora.html" class="page">Interaction Between Sipi and Knora</a></li>
  </ul></li>
  <li><a href="../../../faq.html" class="page">Frequently Asked Questions</a></li>
  <li><a href="../../../00-release-notes/index.html" class="page">Release Notes</a>
  <ul>
    <li><a href="../../../00-release-notes/v1.1.0.html" class="page">v1.1.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.2.0.html" class="page">v1.2.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.3.0.html" class="page">v1.3.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.4.0.html" class="page">v1.4.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.5.0.html" class="page">v1.5.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.6.0.html" class="page">v1.6.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.7.0.html" class="page">v1.7.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v2.x.x.html" class="page">v2.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v3.x.x.html" class="page">v3.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v4.x.x.html" class="page">v4.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v5.x.x.html" class="page">v5.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v6.x.x.html" class="page">v6.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/next.html" class="page">Release Notes for Next Release</a></li>
    <li><a href="../../../00-release-notes/migration.html" class="page">Migration Notes</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../../05-internals/design/principles/triplestore-updates.html#triplestore-updates" class="header">Triplestore Updates</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#requirements" class="header">Requirements</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#design" class="header">Design</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#sparql-update-examples" class="header">SPARQL Update Examples</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 7.0.0-32-e39736c6-20190612-1147
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../../05-internals/design/principles/triplestore-updates.html#triplestore-updates" class="header">Triplestore Updates</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#requirements" class="header">Requirements</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#design" class="header">Design</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#sparql-update-examples" class="header">SPARQL Update Examples</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<!---
Copyright © 2015-2019 the contributors (see Contributors.md).

This file is part of Knora.

Knora is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Knora is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with Knora.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1><a href="#triplestore-updates" name="triplestore-updates" class="anchor"><span class="anchor-link"></span></a>Triplestore Updates</h1>
<div class="toc ">
<ul>
  <li><a href="../../../05-internals/design/principles/triplestore-updates.html#requirements" class="header">Requirements</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#general" class="header">General</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#permissions" class="header">Permissions</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#ontology-constraints" class="header">Ontology Constraints</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#duplicate-and-redundant-values" class="header">Duplicate and Redundant Values</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#versioning" class="header">Versioning</a>
    <ul>
      <li><a href="../../../05-internals/design/principles/triplestore-updates.html#deleting" class="header">Deleting</a></li>
    </ul></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#linking" class="header">Linking</a></li>
  </ul></li>
  <li><a href="../../../05-internals/design/principles/triplestore-updates.html#design" class="header">Design</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#responsibilities-of-responders" class="header">Responsibilities of Responders</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#application-level-locking" class="header">Application-level Locking</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#ensuring-data-consistency" class="header">Ensuring Data Consistency</a></li>
  </ul></li>
  <li><a href="../../../05-internals/design/principles/triplestore-updates.html#sparql-update-examples" class="header">SPARQL Update Examples</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#finding-a-value-iri-in-a-values-version-history" class="header">Finding a value IRI in a value&rsquo;s version history</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#creating-the-initial-version-of-a-value" class="header">Creating the initial version of a value</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#adding-a-new-version-of-a-value" class="header">Adding a new version of a value</a></li>
    <li><a href="../../../05-internals/design/principles/triplestore-updates.html#getting-all-versions-of-a-value" class="header">Getting all versions of a value</a></li>
  </ul></li>
</ul>
</div>
<h2><a href="#requirements" name="requirements" class="anchor"><span class="anchor-link"></span></a>Requirements</h2>
<h3><a href="#general" name="general" class="anchor"><span class="anchor-link"></span></a>General</h3>
<p>The supported update operations are:</p>
<ul>
  <li>Create a new resource with its initial values.</li>
  <li>Add a new value.</li>
  <li>Change a value.</li>
  <li>Delete a value (i.e. mark it as deleted).</li>
  <li>Delete a resource (i.e. mark it as deleted).</li>
</ul>
<p>Users must be able to edit the same data concurrently.</p>
<p>Each update must be atomic and leave the database in a consistent, meaningful state, respecting ontology constraints and permissions.</p>
<p>The application must not use any sort of long-lived locks, because they tend to hinder concurrent edits, and it is difficult to ensure that they are released when they are no longer needed. Instead, if a user requests an update based on outdated information (because another user has just changed something, and the first user has not found out yet), the update must be not performed, and the application must notify the user who requested it, suggesting that the user should check the relevant data and try again if necessary. (We may eventually provide functionality to help users merge edits in such a situation. The application can also encourage users to coordinate with one another when they are working on the same data, and may eventually provide functionality to facilitate this coordination.)</p>
<p>We can assume that each SPARQL update operation will run in its own database transaction with an isolation level of &lsquo;read committed&rsquo;. This is what GraphDB does when it receives a SPARQL update over HTTP (see <a href="http://graphdb.ontotext.com/documentation/standard/storage.html#transaction-control">GraphDB SE Transactions</a>). We cannot assume that it is possible to run more than one SPARQL update in a single database transaction. (The <a href="http://www.w3.org/TR/sparql11-protocol/">SPARQL 1.1 Protocol</a> does not provide a way to do this, and currently it can be done only by embedding the triplestore in the application and using a vendor-specific API, but we cannot require this in Knora.)</p>
<h3><a href="#permissions" name="permissions" class="anchor"><span class="anchor-link"></span></a>Permissions</h3>
<p>To create a new value (as opposed to a new version of an existing value), the user must have permission to modify the containing resource.</p>
<p>To create a new version of an existing value, the user needs only to have permission to modify the current version of the value; no permissions on the resource are needed.</p>
<p>Since changing a link requires deleting the old link and creating a new one (as described in <a href="triplestore-updates.html#linking">Linking</a>), a user wishing to change a link must have modify permission on both the containing resource and the <code>knora-base:LinkValue</code> for the existing link.</p>
<p>When a new resource or value is created, it can be given default permissions specified the project&rsquo;s admin data, or (only in API v2) custom permissions can be specified.</p>
<h3><a href="#ontology-constraints" name="ontology-constraints" class="anchor"><span class="anchor-link"></span></a>Ontology Constraints</h3>
<p>Knora must not allow an update that would violate an ontology constraint.</p>
<p>When creating a new value (as opposed to adding a new version of an existing value), Knora must not allow the update if the containing resource&rsquo;s OWL class does not contain a cardinality restriction for the submitted property, or if the new value would violate the cardinality restriction.</p>
<p>It must also not allow the update if the type of the submitted value does not match the <code>knora-base:objectClassConstraint</code> of the property, or if the property has no <code>knora-base:objectClassConstraint</code>. In the case of a property that points to a resource, Knora must ensure that the target resource belongs to the OWL class specified in the property&rsquo;s <code>knora-base:objectClassConstraint</code>, or to a subclass of that class.</p>
<h3><a href="#duplicate-and-redundant-values" name="duplicate-and-redundant-values" class="anchor"><span class="anchor-link"></span></a>Duplicate and Redundant Values</h3>
<p>When creating a new value, or changing an existing value, Knora checks whether the submitted value would duplicate an existing value for the same property in the resource. The definition of &lsquo;duplicate&rsquo; depends on the type of value; it does not necessarily mean that the two values are strictly equal. For example, if two text values contain the same Unicode string, they are considered duplicates, even if they have different Standoff markup. If resource <code>R</code> has property <code>P</code> with value <code>V1</code>, and <code>V1</code> is a duplicate of <code>V2</code>, the API server must not add another instance of property <code>P</code> with value <code>V2</code>. However, if the requesting user does not have permission to see <code>V2</code>, the duplicate is allowed, because forbidding it would reveal the contents of <code>V2</code> to the user.</p>
<p>When creating a new version of a value, Knora also checks whether the new version is redundant, given the existing value. It is possible for the definition of &lsquo;redundant&rsquo; can depend on the type of value, but in practice, it means that the values are strictly equal: any change, however trivial, is allowed.</p>
<h3><a href="#versioning" name="versioning" class="anchor"><span class="anchor-link"></span></a>Versioning</h3>
<p>Each Knora value (i.e. something belonging to an OWL class derived from <code>knora-base:Value</code>) is versioned. This means that once created, a value is never modified. Instead, &lsquo;changing&rsquo; a value means creating a new version of the value &mdash; actually a new value &mdash; that points to the previous version using <code>knora-base:previousValue</code>. The versions of a value are a singly-linked list, pointing backwards into the past. When a new version of a value is made, the triple that points from the resource to the old version (using a subproperty of <code>knora-base:hasValue</code>) is removed, and a triple is added to point from the resource to the new version. Thus the resource always points only to the current version of the value, and the older versions are available only via the current version&rsquo;s <code>knora-base:previousValue</code> predicate.</p>
<p>Unlike values, resources (members of OWL classes derived from <code>knora-base:Resource</code>) are not versioned. The data that is attached to a resource, other than its values, can be modified.</p>
<h4><a href="#deleting" name="deleting" class="anchor"><span class="anchor-link"></span></a>Deleting</h4>
<p>Knora does not actually delete resources or values; it only marks them as deleted. Deleted data is normally hidden. All resources and values must have the predicate <code>knora- base:isDeleted</code>, whose object is a boolean. If a resource or value has been marked as deleted, it has <code>knora-base:isDeleted true</code> and has a <code>knora-base:deleteDate</code>. An optional <code>knora-base:deleteComment</code> may be added to explain why the resource or value has been marked as deleted.</p>
<p>Normally, a value is marked as deleted without creating a new version of it. However, link values must be treated as a special case. Before a <code>LinkValue</code> can be marked as deleted, its reference count must be decremented to 0. Therefore, a new version of the <code>LinkValue</code> is made, with a reference count of 0, and it is this new version that is marked as deleted.</p>
<p>Since it is necessary to be able to find out when a resource was deleted, it is not possible to undelete a resource. Moreover, to simplify the checking of cardinality constraints, and for consistency with resources, it is not possible to undelete a value, and no new versions of a deleted value can be made. Instead, if desired, a new resource or value can be created by copying data from a deleted resource or value.</p>
<h3><a href="#linking" name="linking" class="anchor"><span class="anchor-link"></span></a>Linking</h3>
<p>Links must be treated differently to other types of values. Knora needs to maintain information about the link, including permissions and a version history. Since the link does not have a unique IRI of its own, Knora uses RDF <a href="http://www.w3.org/TR/rdf-schema/#ch_reificationvocab">reifications</a> for this purpose. Each link between two resources has exactly one (non-deleted) <code>knora-base:LinkValue</code>. The resource itself has a predicate that points to the <code>LinkValue</code>, using a naming convention in which the word <code>Value</code> is appended to the name of the link predicate to produce the link value predicate. For example, if a resource representing a book has a predicate called <code>hasAuthor</code> that points to another resource, it must also have a predicate called <code>hasAuthorValue</code> that points to the <code>LinkValue</code> in which information about the link is stored. To find a particular <code>LinkValue</code>, one can query it either by using its IRI (if known), or by using its <code>rdf:subject</code>, <code>rdf:predicate</code>, and <code>rdf:object</code> (and excluding link values that are marked as deleted).</p>
<p>Like other values, link values are versioned. The link value predicate always points from the resource to the current version of the link value, and previous versions are available only via the current version&rsquo;s <code>knora-base:previousValue</code> predicate. Deleting a link means deleting the triple that links the two resources, and making a new version of the link value, marked with <code>knora-base:isDeleted</code>. A triple then points from the resource to this new, deleted version (using the link value property).</p>
<p>The API allows a link to be &lsquo;changed&rsquo; so that it points to a different target resource. This is implemented as follows: the existing triple connecting the two resources is removed, and a new triple is added using the same link property and pointing to the new target resource. A new version of the old link&rsquo;s <code>LinkValue</code> is made, marked with <code>knora-base:isDeleted</code>. A new <code>LinkValue</code> is made for the new link. The new <code>LinkValue</code> has no connection to the old one.</p>
<p>When a resource contains <code>knora-base:TextValue</code> with Standoff markup that includes a reference to another resource, this reference is materialised as a direct link between the two resources, to make it easier to query. A special link property, <code>knora-base:hasStandoffLinkTo</code>, is used for this purpose. The corresponding link value property, <code>knora-base:hasStandoffLinkToValue</code>, points to a <code>LinkValue</code>. This <code>LinkValue</code> contains a reference count, indicated by <code>knora-base:valueHasRefCount</code>, that represents the number of text values in the containing resource that include one or more Standoff references to the specified target resource. Each time this number changes, a new version of this <code>LinkValue</code> is made. When the reference count reaches zero, the triple with <code>knora-base:hasStandoffLinkTo</code> is removed, and a new version of the <code>LinkValue</code> is made and marked with <code>knora-base:isDeleted</code>. If the same resource reference later appears again in a text value, a new triple is added using <code>knora-base:hasStandoffLinkTo</code>, and a new <code>LinkValue</code> is made, with no connection to the old one.</p>
<p>For consistency, every <code>LinkValue</code> contains a reference count. If the link property is not <code>knora-base:hasStandoffLinkTo</code>, the reference count will always be either 1 (if the link exists) or 0 (if it has been deleted, in which case the link value will also be marked with <code>knora-base:isDeleted</code>).</p>
<p>When a <code>LinkValue</code> is created for a standoff resource reference, it is given the same permissions as the text value containing the reference.</p>
<h2><a href="#design" name="design" class="anchor"><span class="anchor-link"></span></a>Design</h2>
<h3><a href="#responsibilities-of-responders" name="responsibilities-of-responders" class="anchor"><span class="anchor-link"></span></a>Responsibilities of Responders</h3>
<p>The resources responder (<code>ResourcesResponderV1</code> in API v1, <code>ResourcesResponderV2</code> in API v2) has sole responsibility for generating SPARQL to create and updating resources, and the values responder (<code>ValuesResponderV1</code> or <code>ValuesResponderV2</code>) has sole responsibility for generating SPARQL to create and update values. When a new resource is created with its values, the values responder generates SPARQL statements that can be included in the <code>INSERT</code> clause of a SPARQL update to create the values, and the resources responder adds these statements to the SPARQL update that creates the resource. This ensures that the resource and its values are created in a single SPARQL update operation, and hence in a single triplestore transaction.</p>
<h3><a href="#application-level-locking" name="application-level-locking" class="anchor"><span class="anchor-link"></span></a>Application-level Locking</h3>
<p>The &lsquo;read committed&rsquo; isolation level cannot prevent a scenario where two users want to add the same data at the same time. It is possible that both requests would do pre-update checks and simultaneously find that it is OK to add the data, and that both updates would then succeed, inserting redundant data and possibly violating ontology constraints. Therefore, Knora uses short-lived, application-level write locks on resources, to ensure that only one request at a time can update a given resource. Before each update, the application acquires a lock on a resource. To prevent deadlocks, Knora locks only one resource per API operation. It then does the pre-update checks and the update, then releases the lock. The lock implementation (in <code>IriLocker</code>) requires each API request message to include a random UUID, which is generated in the <a href="design-overview.html#api-routing">API Routing</a> package. Using application-level locks allows us to do pre-update checks in their own transactions, and finally to do the SPARQL update in its own transaction.</p>
<h3><a href="#ensuring-data-consistency" name="ensuring-data-consistency" class="anchor"><span class="anchor-link"></span></a>Ensuring Data Consistency</h3>
<p>Knora enforces consistency constraints using three redundant mechanisms:</p>
<ol>
  <li>By doing pre-update checks using SPARQL SELECT queries and cached ontology data.</li>
  <li>By doing checks in the <code>WHERE</code> clauses of SPARQL updates.</li>
  <li>By using GraphDB&rsquo;s built-in consistency checker (see <a href="consistency-checking.html">Consistency Checking</a>).</li>
</ol>
<p>We take the view that redundant consistency checks are a good thing.</p>
<p>Pre-update checks are SPARQL <code>SELECT</code> queries that are executed while holding an application-level lock on the resource to be updated. These checks should work with any triplestore, and can return helpful, Knora-specific error messages to the client if the request would violate a consistency constraint.</p>
<p>However, the SPARQL update itself is our only chance to do pre-update checks in the same transaction that will perform the update. The design of the <a href="http://www.w3.org/TR/sparql11-update/">SPARQL 1.1 Update</a> standard makes it possible to ensure that if certain conditions are not met, the update will not be performed. In our SPARQL update code, each update contains a <code>WHERE</code> clause, possibly a <code>DELETE</code> clause, and an <code>INSERT</code> clause. The <code>WHERE</code> clause is executed first. It performs consistency checks and provides values for variables that are used in the <code>DELETE</code> and/or <code>INSERT</code> clauses. In our updates, if the expectations of the <code>WHERE</code> clause are not met (e.g. because the data to be updated does not exist), the <code>WHERE</code> clause should return no results; as a result, the update will not be performed.</p>
<p>Regardless of whether the update changes the contents of the triplestore, it returns nothing. If the update did nothing because the conditions of the WHERE clause were not met, the only way to find out is to do a <code>SELECT</code> afterwards. Moreover, in this case, there is no straightforward way to find out which conditions was not met. This is one reason why Knora does pre-update checks using separate <code>SELECT</code> queries and/or cached ontology data, <em>before</em> performing the update. This makes it possible to return specific error messages to the user to indicate why an update cannot be performed.</p>
<p>Moreover, while some checks are easy to do in a SPARQL update, others are difficult, impractical, or impossible. Easy checks include checking whether a resource or value exists or is deleted, and checking that the <code>knora-base:objectClassConstraint</code> of a predicate matches the <code>rdf:type</code> of its intended object. Cardinality checks are not very difficult, but they perform poorly on Jena. Knora does not do permission checks in SPARQL, because its permission-checking algorithm is too complex to be implemented in SPARQL. For this reason, Knora&rsquo;s check for duplicate values cannot be done in SPARQL update code, because it relies on permission checks.</p>
<p>In a bulk import operation, which can create a large number of resources in a single SPARQL update, a <code>WHERE</code> clause can become very expensive for the triplestore, in terms of memory as well as execution time. Moreover, RDF4J (and hence GraphDB) uses a recursive algorithm to parse SPARQL queries with <code>WHERE</code> clauses, so the size of a <code>WHERE</code> clause is limited by the stack space available to the Java Virtual Machine. Therefore, in bulk import operations, Knora uses <code>INSERT DATA</code>, which does not involve a <code>WHERE</code> clause. Bulk imports thus rely on checks (1) and (3) above.</p>
<h2><a href="#sparql-update-examples" name="sparql-update-examples" class="anchor"><span class="anchor-link"></span></a>SPARQL Update Examples</h2>
<p>The following sample SPARQL update code is simpler than what Knora actually does. It is included here to illustrate the way Knora&rsquo;s SPARQL updates are structured and how concurrent updates are handled.</p>
<h3><a href="#finding-a-value-iri-in-a-values-version-history" name="finding-a-value-iri-in-a-values-version-history" class="anchor"><span class="anchor-link"></span></a>Finding a value IRI in a value&rsquo;s version history</h3>
<p>We will need this query below. If a value is present in a resource property&rsquo;s version history, the query returns everything known about the value, or nothing otherwise:</p>
<pre><code>prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;
prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
prefix knora-base: &lt;http://www.knora.org/ontology/knora-base#&gt;

SELECT ?p ?o
WHERE {
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a&quot;) as ?resource)
    BIND(IRI(&quot;http://www.knora.org/ontology/0803/incunabula#book_comment&quot;) as ?property)
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a/values/testComment002&quot;) as ?searchValue)

    ?resource ?property ?currentValue .
    ?currentValue knora-base:previousValue* ?searchValue .
    ?searchValue ?p ?o .
}
</code></pre>
<h3><a href="#creating-the-initial-version-of-a-value" name="creating-the-initial-version-of-a-value" class="anchor"><span class="anchor-link"></span></a>Creating the initial version of a value</h3>
<pre><code>prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;
prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
prefix knora-base: &lt;http://www.knora.org/ontology/knora-base#&gt;

WITH &lt;http://www.knora.org/ontology/0803/incunabula&gt;
INSERT {
    ?newValue rdf:type ?valueType ;
              knora-base:valueHasString &quot;&quot;&quot;Comment 1&quot;&quot;&quot; ;
              knora-base:attachedToUser &lt;http://rdfh.ch/users/91e19f1e01&gt; ;
              knora-base:attachedToProject &lt;http://rdfh.ch/projects/77275339&gt; ;
              knora-base:hasPermissions &quot;V knora-admin:KnownUser,knora-admin:UnknownUser|M knora-admin:ProjectMember&quot;  ;
              knora-base:valueTimestamp ?currentTime .

    ?resource ?property ?newValue .
} WHERE {
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a&quot;) as ?resource)
    BIND(IRI(&quot;http://www.knora.org/ontology/0803/incunabula#book_comment&quot;) as ?property)
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a/values/testComment001&quot;) AS ?newValue)
    BIND(IRI(&quot;http://www.knora.org/ontology/knora-base#TextValue&quot;) AS ?valueType)
    BIND(NOW() AS ?currentTime)

    # Do nothing if the resource doesn&#39;t exist.
    ?resource rdf:type ?resourceClass .

    # Do nothing if the submitted value has the wrong type.
    ?property knora-base:objectClassConstraint ?valueType .
}
</code></pre>
<p>To find out whether the insert succeeded, the application can use the query in <a href="triplestore-updates.html#finding-a-value-iri-in-a-values-version-history">Finding a value IRI in a value&rsquo;s version history</a> to look for the new IRI in the property&rsquo;s version history.</p>
<h3><a href="#adding-a-new-version-of-a-value" name="adding-a-new-version-of-a-value" class="anchor"><span class="anchor-link"></span></a>Adding a new version of a value</h3>
<pre><code>prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;
prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
prefix knora-base: &lt;http://www.knora.org/ontology/knora-base#&gt;

WITH &lt;http://www.knora.org/ontology/0803/incunabula&gt;
DELETE {
    ?resource ?property ?currentValue .
} INSERT {
    ?newValue rdf:type ?valueType ;
              knora-base:valueHasString &quot;&quot;&quot;Comment 2&quot;&quot;&quot; ;
              knora-base:previousValue ?currentValue ;
              knora-base:attachedToUser &lt;http://rdfh.ch/users/91e19f1e01&gt; ;
              knora-base:attachedToProject &lt;http://rdfh.ch/projects/77275339&gt; ;
              knora-base:hasPermissions &quot;V knora-admin:KnownUser,knora-admin:UnknownUser|M knora-admin:ProjectMember&quot;  ;
              knora-base:valueTimestamp ?currentTime .

    ?resource ?property ?newValue .
} WHERE {
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a&quot;) as ?resource)
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a/values/testComment001&quot;) AS ?currentValue)
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a/values/testComment002&quot;) AS ?newValue)
    BIND(IRI(&quot;http://www.knora.org/ontology/knora-base#TextValue&quot;) AS ?valueType)
    BIND(NOW() AS ?currentTime)

    ?resource ?property ?currentValue .
    ?property knora-base:objectClassConstraint ?valueType .
}
</code></pre>
<p>The update request must contain the IRI of the most recent version of the value (<code>http://rdfh.ch/c5058f3a/values/c3295339</code>). If this is not in fact the most recent version (because someone else has done an update), this operation will do nothing (because the <code>WHERE</code> clause will return no rows). To find out whether the update succeeded, the application will then need to do a SELECT query using the query in <a href="triplestore-updates.html#finding-a-value-iri-in-a-values-version-history">Finding a value IRI in a value&rsquo;s version history</a>. In the case of concurrent updates, there are two possibilities:</p>
<ol>
  <li>Users A and B are looking at version 1. User A submits an update and it succeeds, creating version 2, which user A verifies using a SELECT. User B then submits an update to version 1 but it fails, because version 1 is no longer the latest version. User B&rsquo;s SELECT will find that user B&rsquo;s new value IRI is absent from the value&rsquo;s version history.</li>
  <li>Users A and B are looking at version 1. User A submits an update and it succeeds, creating version 2. Before User A has time to do a SELECT, user B reads the new value and updates it again. Both users then do a SELECT, and find that both their new value IRIs are present in the value&rsquo;s version history.</li>
</ol>
<h3><a href="#getting-all-versions-of-a-value" name="getting-all-versions-of-a-value" class="anchor"><span class="anchor-link"></span></a>Getting all versions of a value</h3>
<pre><code>prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;
prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
prefix knora-base: &lt;http://www.knora.org/ontology/knora-base#&gt;

SELECT ?value ?valueTimestamp ?previousValue
WHERE {
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a&quot;) as ?resource)
    BIND(IRI(&quot;http://www.knora.org/ontology/0803/incunabula#book_comment&quot;) as ?property)
    BIND(IRI(&quot;http://rdfh.ch/c5058f3a/values/testComment002&quot;) AS ?currentValue)

    ?resource ?property ?currentValue .
    ?currentValue knora-base:previousValue* ?value .

    OPTIONAL {
        ?value knora-base:valueTimestamp ?valueTimestamp .
    }

    OPTIONAL {
        ?value knora-base:previousValue ?previousValue .
    }
}
</code></pre>
<p>This assumes that we know the current version of the value. If the version we have is not actually the current version, this query will return no rows.</p>
</div>
<div>
<a href="https://github.com/dhlab-basel/Knora/tree/master/docs/src/paradox/05-internals/design/principles/triplestore-updates.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
7.0.0-32-e39736c6-20190612-1147
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../05-internals/design/principles/store-module.html" title="Store Module" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Store Module
</span>
</div>
</a>
<a href="../../../05-internals/design/principles/consistency-checking.html" title="Consistency Checking" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Consistency Checking
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright 2015-2019 the contributors (see Contributors.md)
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/dhlab-basel" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/dhlabbasel" class="md-footer-social__link fa fa-twitter"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../../../assets/javascripts/application.5165553b.js"></script>
<script src="../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../."}})</script>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
