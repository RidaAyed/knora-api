<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../cloud">
<title>Knora API Server Design Overview · Knora Documentation</title>
<link rel="stylesheet" href="../../../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../../../assets/stylesheets/application-palette.792431c1.css">
<link rel="stylesheet" href="../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../lib/prettify/prettify.css">
<script src="../../../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
data-md-color-primary="blue"
data-md-color-accent="yellow"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../index.html" title="Knora Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">cloud</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Knora Documentation
</span>
<span class="md-header-nav__topic">
Knora API Server Design Overview
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">cloud</i>
</span>
<a href="../../../index.html" title="Knora Documentation">
Knora Documentation
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
<ul>
  <li><a href="../../../01-introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../../01-introduction/what-is-knora.html" class="page">What Is Knora?</a></li>
    <li><a href="../../../01-introduction/data-formats.html" class="page">Data Formats in Knora</a></li>
    <li><a href="../../../01-introduction/standoff-rdf.html" class="page">Standoff/RDF Text Markup</a></li>
    <li><a href="../../../01-introduction/example-project.html" class="page">An Example Project</a></li>
  </ul></li>
  <li><a href="../../../02-knora-ontologies/index.html" class="page">Knora Ontologies</a>
  <ul>
    <li><a href="../../../02-knora-ontologies/introduction.html" class="page">Introduction</a></li>
    <li><a href="../../../02-knora-ontologies/knora-base.html" class="page">The Knora Base Ontology</a></li>
    <li><a href="../../../02-knora-ontologies/salsah-gui.html" class="page">The SALSAH GUI Ontology</a></li>
  </ul></li>
  <li><a href="../../../03-apis/index.html" class="page">The Knora APIs</a>
  <ul>
    <li><a href="../../../03-apis/api-v1/index.html" class="page">Knora API v1</a></li>
    <li><a href="../../../03-apis/api-v2/index.html" class="page">Knora API v2</a></li>
    <li><a href="../../../03-apis/api-admin/index.html" class="page">Knora Admin API</a></li>
  </ul></li>
  <li><a href="../../../04-deployment/index.html" class="page">Deploying Knora</a>
  <ul>
    <li><a href="../../../04-deployment/getting-started.html" class="page">Getting Started with Knora</a></li>
    <li><a href="../../../04-deployment/configuration.html" class="page">Configuration</a></li>
    <li><a href="../../../04-deployment/updates.html" class="page">Updating Repositories When Upgrading Knora</a></li>
  </ul></li>
  <li><a href="../../../05-internals/index.html" class="page">Knora Internals</a>
  <ul>
    <li><a href="../../../05-internals/design/index.html" class="page">Design</a></li>
    <li><a href="../../../05-internals/development/index.html" class="page">Development</a></li>
  </ul></li>
  <li><a href="../../../06-salsah/index.html" class="page">The SALSAH 1 GUI</a></li>
  <li><a href="../../../07-sipi/index.html" class="page">The Sipi Media Server</a>
  <ul>
    <li><a href="../../../07-sipi/setup-sipi-for-knora.html" class="page">Setting Up Sipi for Knora</a></li>
    <li><a href="../../../07-sipi/sipi-and-knora.html" class="page">Interaction Between Sipi and Knora</a></li>
  </ul></li>
  <li><a href="../../../faq.html" class="page">Frequently Asked Questions</a></li>
  <li><a href="../../../00-release-notes/index.html" class="page">Release Notes</a>
  <ul>
    <li><a href="../../../00-release-notes/v1.1.0.html" class="page">v1.1.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.2.0.html" class="page">v1.2.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.3.0.html" class="page">v1.3.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.4.0.html" class="page">v1.4.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.5.0.html" class="page">v1.5.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.6.0.html" class="page">v1.6.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.7.0.html" class="page">v1.7.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v2.x.x.html" class="page">v2.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v3.x.x.html" class="page">v3.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v4.x.x.html" class="page">v4.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v5.x.x.html" class="page">v5.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v6.x.x.html" class="page">v6.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/next.html" class="page">Release Notes for Next Release</a></li>
    <li><a href="../../../00-release-notes/migration.html" class="page">Migration Notes</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../../05-internals/design/principles/design-overview.html#knora-api-server-design-overview" class="header">Knora API Server Design Overview</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/design-overview.html#introduction" class="header">Introduction</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#knora-apis" class="header">Knora APIs</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#design-diagram" class="header">Design Diagram</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#modules" class="header">Modules</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#actor-supervision-and-creation" class="header">Actor Supervision and Creation</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#coordinated-application-startup" class="header">Coordinated Application Startup</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#concurrency" class="header">Concurrency</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#what-the-responders-do" class="header">What the Responders Do</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#store-module-org-knora-webapi-store-package-" class="header">Store Module (org.knora.webapi.store package)</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#triplestore-access" class="header">Triplestore Access</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#error-handling" class="header">Error Handling</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#api-routing" class="header">API Routing</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 8.0.0
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../../05-internals/design/principles/design-overview.html#knora-api-server-design-overview" class="header">Knora API Server Design Overview</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/design-overview.html#introduction" class="header">Introduction</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#knora-apis" class="header">Knora APIs</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#design-diagram" class="header">Design Diagram</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#modules" class="header">Modules</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#actor-supervision-and-creation" class="header">Actor Supervision and Creation</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#coordinated-application-startup" class="header">Coordinated Application Startup</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#concurrency" class="header">Concurrency</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#what-the-responders-do" class="header">What the Responders Do</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#store-module-org-knora-webapi-store-package-" class="header">Store Module (org.knora.webapi.store package)</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#triplestore-access" class="header">Triplestore Access</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#error-handling" class="header">Error Handling</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#api-routing" class="header">API Routing</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<!---
Copyright © 2015-2019 the contributors (see Contributors.md).

This file is part of Knora.

Knora is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Knora is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with Knora.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1><a href="#knora-api-server-design-overview" name="knora-api-server-design-overview" class="anchor"><span class="anchor-link"></span></a>Knora API Server Design Overview</h1>
<div class="toc ">
<ul>
  <li><a href="../../../05-internals/design/principles/design-overview.html#introduction" class="header">Introduction</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#knora-apis" class="header">Knora APIs</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#design-diagram" class="header">Design Diagram</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#modules" class="header">Modules</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/design-overview.html#http-module" class="header">HTTP Module</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#responders-module" class="header">Responders Module</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#store-module" class="header">Store Module</a></li>
    <li><a href="../../../05-internals/design/principles/design-overview.html#shared-between-modules" class="header">Shared Between Modules</a></li>
  </ul></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#actor-supervision-and-creation" class="header">Actor Supervision and Creation</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#coordinated-application-startup" class="header">Coordinated Application Startup</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#concurrency" class="header">Concurrency</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#what-the-responders-do" class="header">What the Responders Do</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#store-module-org-knora-webapi-store-package-" class="header">Store Module (org.knora.webapi.store package)</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#triplestore-access" class="header">Triplestore Access</a></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#error-handling" class="header">Error Handling</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/design-overview.html#transformation-of-exception-to-client-responses" class="header">Transformation of Exception to Client Responses</a></li>
  </ul></li>
  <li><a href="../../../05-internals/design/principles/design-overview.html#api-routing" class="header">API Routing</a></li>
</ul>
</div>
<h2><a href="#introduction" name="introduction" class="anchor"><span class="anchor-link"></span></a>Introduction</h2>
<p>Knora&rsquo;s responsibilities include:</p>
<ul>
  <li>Receiving, validating, authenticating, and authorising HTTP requests from  clients (which may be web browsers or other software) to query or update  data in a Knora repository.</li>
  <li>Querying and updating the repository on behalf of clients.</li>
  <li>Filtering query results according to the user&rsquo;s permissions.</li>
  <li>Transforming query results into Knora API responses.</li>
  <li>Ensuring that ontologies and data in the triplestore are consistent and  conform to the requirements of the  <a href="../../../02-knora-ontologies/knora-base.html">knora-base</a> ontology.</li>
  <li>Managing the versioning of data in the triplestore.</li>
  <li>Working with <a href="http://sipi.io">Sipi</a> to store files that cannot be stored  as RDF data.</li>
</ul>
<p>Knora is written in <a href="http://www.scala-lang.org/">Scala</a>, using the <a href="http://akka.io/">Akka</a> framework for message-based concurrency. It is designed to work with any standards-compliant triplestore via the <a href="http://www.w3.org/TR/sparql11-protocol/">SPARQL 1.1 Protocol</a>, but is currently tested only with <a href="http://graphdb.ontotext.com/">Ontotext GraphDB</a> (with support for other triplestores coming soon).</p>
<h2><a href="#knora-apis" name="knora-apis" class="anchor"><span class="anchor-link"></span></a>Knora APIs</h2>
<p>Knora supports different versions of its API for working with humanities data:</p>
<ul>
  <li><a href="../../../03-apis/api-v2/index.html">Knora API v2</a>, a standards-based  API currently under development.</li>
  <li><a href="../../../03-apis/api-v1/index.html">Knora API v1</a>, a stable, legacy API  that focuses on maintaining compatibility with applications that used  Knora&rsquo;s prototype software.</li>
</ul>
<p>There is also a <a href="../../../03-apis/api-admin/index.html">Knora admin API</a> for administering Knora repositories.</p>
<p>The Knora code base includes some functionality that is shared by these different APIs, as well as separate packages for each API. Internally, Knora APIs v1 and v2 both use functionality in the admin API. Knora API v1 uses some functionality from API v2, but API v2 does not depend on API v1.</p>
<h2><a href="#design-diagram" name="design-diagram" class="anchor"><span class="anchor-link"></span></a>Design Diagram</h2>
<p><img src="figures/design-diagram.png" alt="A high-level diagram of Knora." title="A high-level diagram of Knora." /></p>
<h2><a href="#modules" name="modules" class="anchor"><span class="anchor-link"></span></a>Modules</h2>
<h3><a href="#http-module" name="http-module" class="anchor"><span class="anchor-link"></span></a>HTTP Module</h3>
<ul>
  <li><code>org.knora.webapi.routing</code>: Knora&rsquo;s <a href="https://akka.io/akka-http/">Akka HTTP</a> routes.  Each routing class matches URL patterns for requests involving some particular  type of data in the repository. Routes are API-specific. For example,  <code>ResourcesRouteV2</code> matches URL paths starting with <code>/v2/resources</code>, which  represent requests involving Knora resources.</li>
  <li><code>org.knora.webapi.http</code>: a few HTTP-related constants and utilities.</li>
</ul>
<h3><a href="#responders-module" name="responders-module" class="anchor"><span class="anchor-link"></span></a>Responders Module</h3>
<ul>
  <li><code>org.knora.webapi.responders</code>: Each responder is an actor that is responsible for managing  some particular type of data in the repository. A responder receives messages from  a route, does some work (e.g. querying the triplestore), and returns a reply  message. Responders are API-specific and can communicate with other responders  via messages. For example, in API v2, <code>ResourcesResponderV2</code> handles requests  involving resources, and delegates some of its tasks to <code>ValuesResponderV2</code>,  which is responsible for requests involving values.</li>
</ul>
<h3><a href="#store-module" name="store-module" class="anchor"><span class="anchor-link"></span></a>Store Module</h3>
<ul>
  <li><code>org.knora.webapi.store</code>: Contains actors that connect to triplestores. The  most important one is <code>HttpTriplestoreConnector</code>, which communicates with  triplestores via the  <a href="http://www.w3.org/TR/sparql11-protocol/">SPARQL 1.1 Protocol</a>.</li>
</ul>
<h3><a href="#shared-between-modules" name="shared-between-modules" class="anchor"><span class="anchor-link"></span></a>Shared Between Modules</h3>
<ul>
  <li><code>org.knora.webapi</code>: Contains core classes such as <code>Main</code>, which starts the  Knora server, and <code>SettingsImpl</code>, which represents the application settings  that are loaded using the <a href="https://github.com/lightbend/config">Typesafe Config</a>  library.</li>
  <li><code>org.knora.webapi.util</code>: Utilities needed by different parts of the application,  such as parsing and formatting tools.</li>
  <li><code>org.knora.webapi.messages</code>: The Akka messages used by each responder.</li>
  <li><code>org.knora.webapi.twirl</code>: Text-generation templates for use with  <a href="https://github.com/playframework/twirl">the Twirl template engine</a>. Knora  uses Twirl to generate SPARQL requests and other types of text documents.</li>
</ul>
<h2><a href="#actor-supervision-and-creation" name="actor-supervision-and-creation" class="anchor"><span class="anchor-link"></span></a>Actor Supervision and Creation</h2>
<p>At system start, the supervisor actors are created in <code>KnoraService.scala</code>:</p>
<pre class="prettyprint"><code class="language-scala">/**
  * The supervisor actor that forwards messages to actors that deal with persistent storage.
  */
protected val storeManager: ActorRef = system.actorOf(Props(new StoreManager with LiveActorMaker).withDispatcher(KnoraDispatchers.KnoraActorDispatcher), name = StoreManagerActorName)


/**
  * The supervisor actor that forwards messages to responder actors to handle API requests.
  */
protected val responderManager: ActorRef = system.actorOf(Props(new ResponderManager(applicationStateActor, storeManager) with LiveActorMaker).withDispatcher(KnoraDispatchers.KnoraActorDispatcher), name = RESPONDER_MANAGER_ACTOR_NAME)</code></pre>
<p>In most cases, there is only one instance of each supervised actor; such actors do their work asynchronously in futures, so there would be no advantage in using an actor pool. A few actors do have pools of instances, because they do their work synchronously; this allows concurrency to be controlled by setting the size of each pool. These pools are configured in <code>application.conf</code> under <code>akka.actor.deployment</code>.</p>
<p><code>KnoraService</code> also starts the HTTP service after which the startup sequence is initiated:</p>
<pre class="prettyprint"><code class="language-scala">/**
  * Starts the Knora API server.
  */
def startService(skipLoadingOfOntologies: Boolean): Unit = {

    val bindingFuture: Future[Http.ServerBinding] = Http().bindAndHandle(Route.handlerFlow(apiRoutes), settings.internalKnoraApiHost, settings.internalKnoraApiPort)

    bindingFuture onComplete {
        case Success(_) =&gt; {

            // start monitoring reporters
            startReporters()

            // Kick of startup procedure.
            applicationStateActor ! InitStartUp(skipLoadingOfOntologies)
        }
        case Failure(ex) =&gt; {
            log.error(&quot;Failed to bind to {}:{}! - {}&quot;, settings.internalKnoraApiHost, settings.internalKnoraApiPort, ex.getMessage)
            stopService()
        }
    }
}</code></pre>
<h2><a href="#coordinated-application-startup" name="coordinated-application-startup" class="anchor"><span class="anchor-link"></span></a>Coordinated Application Startup</h2>
<p>To coordinate necessary startup tasks, the application goes through a few states at startup:</p>
<ul>
  <li>Stopped: Application starting. Http layer is still not started.</li>
  <li>StartingUp: Http layer is started. Only &lsquo;/health&rsquo; and monitoring routes are working.</li>
  <li>WaitingForRepository: Repository check is initiated but not yet finished.</li>
  <li>RepositoryReady: Repository check has finished and repository is available.</li>
  <li>CreatingCaches: Creating caches is initiated but not yet finished.</li>
  <li>CachesReady: Caches are created and ready for use.</li>
  <li>LoadingOntologies: Loading of ontologies is initiated but not yet finished.</li>
  <li>OntologiesReady: Ontologies are loaded.</li>
  <li>MaintenanceMode: During backup or other maintenance tasks, so that access to the API is closed</li>
  <li>Running: Running state. All APIs are open.</li>
</ul>
<p>The startup sequence coordination is done by the <code>org.knora.webapi.app.ApplicationStateActor</code>. During the <code>WaitingForRepository</code> state, if the repository is not configured or available, the system will indefinitely retry to access it. This allows for prolonged startup times of the repository.</p>
<h2><a href="#concurrency" name="concurrency" class="anchor"><span class="anchor-link"></span></a>Concurrency</h2>
<p>In general, Knora is written in a functional style, avoiding shared mutable state. This makes it easier to reason about concurrency, and eliminates an important potential source of bugs (see <a href="http://curtclifton.net/papers/MoseleyMarks06a.pdf">Out of the Tar Pit</a>).</p>
<p>The routes and actors in Knora use Akka&rsquo;s <code>ask</code> pattern, rather than the <code>tell</code> pattern, to send messages and receive responses, because this simplifies the code considerably (using <code>tell</code> would require actors to maintain complex mutable state), with no apparent reduction in performance.</p>
<p>To manage asynchronous communication between actors, the Knora API server uses Scala&rsquo;s <code>Future</code> monad extensively. See <a href="futures-with-akka.html">Futures with Akka</a> for details.</p>
<p>We use Akka&rsquo;s asynchronous logging interface (see <a href="http://doc.akka.io/docs/akka/current/scala/logging.html">Akka Logging</a>).</p>
<h2><a href="#what-the-responders-do" name="what-the-responders-do" class="anchor"><span class="anchor-link"></span></a>What the Responders Do</h2>
<p>In Knora, a responder is an actor that receives a request message (a Scala case class) in the <code>ask</code> pattern, does some work (e.g. getting data from the triplestore), and returns a reply message (another case class). These reply messages are are defined in <code>org.knora.webapi.messages</code>. A responder can produce a reply representing a complete API response, or part of a response that will be used by another responder. If it&rsquo;s a complete API response, there is an API-specific mechanism for converting it into the response format that the client expects.</p>
<h2><a href="#store-module-org-knora-webapi-store-package-" name="store-module-org-knora-webapi-store-package-" class="anchor"><span class="anchor-link"></span></a>Store Module (org.knora.webapi.store package)</h2>
<p>The store module is used for accessing the triplestore and other external storage providers.</p>
<p>All access to the Store module goes through the <code>StoreManager</code> supervisor actor. The <code>StoreManager</code> creates pools of actors, such as <code>HttpTriplestoreActor</code>, that interface with the storage providers.</p>
<p>The contents of the <code>store</code> package are not used directly by other packages, which interact with the <code>store</code> package only by sending messages to <code>StoreManager</code>.</p>
<p>Parsing of SPARQL query results is handled by this module.</p>
<p>See <a href="store-module.html">Store Module</a> for a more detailed discussion.</p>
<h2><a href="#triplestore-access" name="triplestore-access" class="anchor"><span class="anchor-link"></span></a>Triplestore Access</h2>
<p>SPARQL queries are generated from templates, using the <a href="https://github.com/playframework/twirl">Twirl</a> template engine. For example, if we&rsquo;re querying a resource, the template will contain a placeholder for the resource&rsquo;s IRI. The templates can be found under <code>src/main/twirl/queries/sparql</code>. In many cases, different SPARQL must be generated for different triplestores; the Twirl template function then takes the name of the triplestore as a parameter, and may delegate to triplestore-specific templates.</p>
<p>Responders are not expected to know which triplestore is being used or how it is accessed. To perform a SPARQL SELECT query, a responder sends a <code>SparqlSelectRequest</code> message to the <code>storeManager</code> actor, like this:</p>
<pre class="prettyprint"><code class="language-scala">for {
    isEntityUsedSparql &lt;- Future(queries.sparql.v2.txt.isEntityUsed(
        triplestore = settings.triplestoreType,
        entityIri = entityIri,
        ignoreKnoraConstraints = ignoreKnoraConstraints
    ).toString())

    isEntityUsedResponse: SparqlSelectResponse &lt;- (storeManager ? SparqlSelectRequest(isEntityUsedSparql)).mapTo[SparqlSelectResponse]</code></pre>
<p>The reply message, <code>SparqlSelectResponse</code>, is a data structure containing the rows that were returned as the query result.</p>
<p>To perform a SPARQL CONSTRUCT query, you can use <code>SparqlExtendedConstructRequest</code>, and the response will be a <code>SparqlExtendedConstructResponse</code>.</p>
<h2><a href="#error-handling" name="error-handling" class="anchor"><span class="anchor-link"></span></a>Error Handling</h2>
<p>The error-handling design has these aims:</p>
<ol>
  <li>Simplify the error-handling code in actors as much as possible.</li>
  <li>Produce error messages that clearly indicate the context in which the error occurred (i.e. what the application was trying to do).</li>
  <li>Ensure that clients receive an appropriate error message when an error occurs.</li>
  <li>Ensure that <code>ask</code> requests are properly terminated with an <code>akka.actor.Status.Failure</code> message in the event of an error, without which they will simply time out (see <a href="https://doc.akka.io/docs/akka/current/actors.html?language=scala#ask-send-and-receive-future">Ask: Send and Receive Future</a>).</li>
  <li>When a actor encounters an error that isn&rsquo;t the client&rsquo;s fault (e.g. a triplestore failure), log it, but don&rsquo;t do this with errors caused by bad input.</li>
  <li>When logging errors, include the full JVM stack trace.</li>
</ol>
<p>The design does not yet include, but could easily accommodate, translations of error messages into different languages.</p>
<p>A hierarchy of exception classes is defined in <code>Exceptions.scala</code>, representing different sorts of errors that could occur. The hierarchy has two main branches:</p>
<ul>
  <li><code>RequestRejectedException</code>, an abstract class for errors that are the client&rsquo;s fault. These errors are not logged.</li>
  <li><code>InternalServerException</code>, an abstract class for errors that are not the client&rsquo;s fault. These errors are logged.</li>
</ul>
<p>Exception classes in this hierarchy can be defined to include a wrapped <code>cause</code> exception. When an exception is logged, its stack trace will be logged along with the stack trace of its <code>cause</code>. It is therefore recommended that low-level code should catch low-level exceptions, and wrap them in one of our higher-level exceptions, in order to clarify the context in which the error occurred.</p>
<p>To simplify error-handling in responders, a utility method called <code>future2Message</code> is provided in <code>ActorUtils</code>. It is intended to be used in an actor&rsquo;s <code>receive</code> method to respond to messages in the <code>ask</code> pattern. If the responder&rsquo;s computation is successful, it is sent to the requesting actor as a response to the <code>ask</code>. If the computation fails, the exception representing the failure is wrapped in a <code>Status.Failure</code>, which is sent as a response to the <code>ask</code>. If the error is a subclass of <code>RequestRejectedException</code>, only the sender is notified of the error; otherwise, the error is also logged and rethrown (so that the <code>KnoraExceptionHandler</code> can handle the exception).</p>
<p>In many cases, we transform data from the triplestore into a <code>Map</code> object. To simplify checking for required values in these collections, the class <code>ErrorHandlingMap</code> is provided. You can wrap any <code>Map</code> in an <code>ErrorHandlingMap</code>. You must provide a function that will generate an error message when a required value is missing, and optionally a function that throws a particular exception. Rows of SPARQL query results are already returned in <code>ErrorHandlingMap</code> objects.</p>
<p>If you want to add a new exception class, see the comments in <code>Exceptions.scala</code> for instructions.</p>
<h3><a href="#transformation-of-exception-to-client-responses" name="transformation-of-exception-to-client-responses" class="anchor"><span class="anchor-link"></span></a>Transformation of Exception to Client Responses</h3>
<p>The <code>org.knora.webapi.KnoraExceptionHandler</code> is brought implicitly into scope of <code>akka-http</code>, and by doing so registered and used to handle the transformation of all <code>KnoraExceptions</code> into <code>HttpResponses</code>. This handler handles only exceptions thrown inside the route and not the actors. However, the design of reply message passing from actors (by using <code>future2Message</code>), makes sure that any exceptions thrown inside actors, will reach the route, where they will be handled.</p>
<p>See also <a href="futures-with-akka.html">Fuures with Akka</a>.</p>
<h2><a href="#api-routing" name="api-routing" class="anchor"><span class="anchor-link"></span></a>API Routing</h2>
<p>The API routes in the <code>routing</code> package are defined using the DSL provided by the <a href="http://doc.akka.io/docs/akka/current/scala/http/routing-dsl/index.html">akka-http</a> library. A routing function has to do the following:</p>
<ol>
  <li>Authenticate the client.</li>
  <li>Figure out what the client is asking for.</li>
  <li>Construct an appropriate request message and send it to <code>ResponderManagerV1</code>, using the <code>ask</code> pattern.</li>
  <li>Return a result to the client.</li>
</ol>
<p>To simplify the coding of routing functions, they are contained in objects that extend <code>org.knora.webapi.routing.Authenticator</code>. Each routing function performs the following operations:</p>
<ol>
  <li><code>Authenticator.getUserADM</code> is called to authenticate the user.</li>
  <li>The request parameters are interpreted and validated, and a request message is constructed to send to the responder. If the request is invalid, <code>BadRequestException</code> is thrown. If the request message is requesting an update operation, it must include a UUID generated by <code>UUID.randomUUID</code>, so the responder can obtain a write lock on the resource being updated.</li>
</ol>
<p>The routing function then passes the message to a function in an API-specific routing utility: <code>RouteUtilV1</code>, <code>RouteUtilV2</code>, or <code>RouteUtilADM</code>. This utility function sends the message to <code>ResponderManager</code> (which forwards it to the relevant responder), returns a response to the client in the appropriate format, and handles any errors.</p>
</div>
<div>
<a href="https://github.com/dhlab-basel/Knora/tree/master/docs/src/paradox/05-internals/design/principles/design-overview.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
8.0.0
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../05-internals/design/principles/index.html" title="Knora Design Principles" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Knora Design Principles
</span>
</div>
</a>
<a href="../../../05-internals/design/principles/futures-with-akka.html" title="Futures with Akka" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Futures with Akka
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright 2015-2019 the contributors (see Contributors.md)
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/dhlab-basel" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/dhlabbasel" class="md-footer-social__link fa fa-twitter"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../../../assets/javascripts/application.5165553b.js"></script>
<script src="../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../."}})</script>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
