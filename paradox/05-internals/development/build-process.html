<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../cloud">
<title>Build Process · Knora Documentation</title>
<link rel="stylesheet" href="../../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../../assets/stylesheets/application-palette.792431c1.css">
<link rel="stylesheet" href="../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../lib/prettify/prettify.css">
<script src="../../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
data-md-color-primary="blue"
data-md-color-accent="yellow"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../index.html" title="Knora Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">cloud</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Knora Documentation
</span>
<span class="md-header-nav__topic">
Build Process
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">cloud</i>
</span>
<a href="../../index.html" title="Knora Documentation">
Knora Documentation
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
<ul>
  <li><a href="../../01-introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../01-introduction/what-is-knora.html" class="page">What Is Knora?</a></li>
    <li><a href="../../01-introduction/example-project.html" class="page">An Example Project</a></li>
  </ul></li>
  <li><a href="../../02-knora-ontologies/index.html" class="page">Knora Ontologies</a>
  <ul>
    <li><a href="../../02-knora-ontologies/introduction.html" class="page">Introduction</a></li>
    <li><a href="../../02-knora-ontologies/knora-base.html" class="page">The Knora Base Ontology</a></li>
    <li><a href="../../02-knora-ontologies/salsah-gui.html" class="page">The SALSAH GUI Ontology</a></li>
  </ul></li>
  <li><a href="../../03-apis/index.html" class="page">The Knora APIs</a>
  <ul>
    <li><a href="../../03-apis/api-v1/index.html" class="page">Knora API v1</a></li>
    <li><a href="../../03-apis/api-v2/index.html" class="page">Knora API v2</a></li>
    <li><a href="../../03-apis/api-admin/index.html" class="page">Knora Admin API</a></li>
  </ul></li>
  <li><a href="../../04-deployment/index.html" class="page">Deploying Knora</a>
  <ul>
    <li><a href="../../04-deployment/getting-started.html" class="page">Getting Started with Knora</a></li>
    <li><a href="../../04-deployment/configuration.html" class="page">Configuration</a></li>
  </ul></li>
  <li><a href="../../05-internals/index.html" class="page">Knora Internals</a>
  <ul>
    <li><a href="../../05-internals/design/index.html" class="page">Design</a></li>
    <li><a href="../../05-internals/development/index.html" class="page">Development</a></li>
  </ul></li>
  <li><a href="../../06-salsah/index.html" class="page">The SALSAH 1 GUI</a></li>
  <li><a href="../../07-sipi/index.html" class="page">The Sipi Media Server</a>
  <ul>
    <li><a href="../../07-sipi/setup-sipi-for-knora.html" class="page">Setting Up Sipi for Knora</a></li>
    <li><a href="../../07-sipi/sipi-and-knora.html" class="page">Interaction Between Sipi and Knora</a></li>
  </ul></li>
  <li><a href="../../faq.html" class="page">Frequently Asked Questions</a></li>
  <li><a href="../../00-release-notes/index.html" class="page">Release Notes</a>
  <ul>
    <li><a href="../../00-release-notes/v1.1.0.html" class="page">v1.1.0 Release Notes</a></li>
    <li><a href="../../00-release-notes/v1.2.0.html" class="page">v1.2.0 Release Notes</a></li>
    <li><a href="../../00-release-notes/v1.3.0.html" class="page">v1.3.0 Release Notes</a></li>
    <li><a href="../../00-release-notes/v1.4.0.html" class="page">v1.4.0 Release Notes</a></li>
    <li><a href="../../00-release-notes/v1.5.0.html" class="page">v1.5.0 Release Notes</a></li>
    <li><a href="../../00-release-notes/v1.6.0.html" class="page">v1.6.0 Release Notes</a></li>
    <li><a href="../../00-release-notes/v1.7.0.html" class="page">v1.7.x Release Notes</a></li>
    <li><a href="../../00-release-notes/v2.x.x.html" class="page">v2.x.x Release Notes</a></li>
    <li><a href="../../00-release-notes/v3.x.x.html" class="page">v3.x.x Release Notes</a></li>
    <li><a href="../../00-release-notes/next.html" class="page">Release Notes for Next Release</a></li>
    <li><a href="../../00-release-notes/migration.html" class="page">Migration Notes</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../05-internals/development/build-process.html#build-process" class="header">Build Process</a>
  <ul>
    <li><a href="../../05-internals/development/build-process.html#sbt-build-configuration" class="header">SBT Build Configuration</a></li>
    <li><a href="../../05-internals/development/build-process.html#building-deployment-packages" class="header">Building Deployment Packages</a></li>
    <li><a href="../../05-internals/development/build-process.html#building-docker-images" class="header">Building Docker Images</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 3.0.0-0-d71e52b7-20181130-1525
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../05-internals/development/build-process.html#build-process" class="header">Build Process</a>
  <ul>
    <li><a href="../../05-internals/development/build-process.html#sbt-build-configuration" class="header">SBT Build Configuration</a></li>
    <li><a href="../../05-internals/development/build-process.html#building-deployment-packages" class="header">Building Deployment Packages</a></li>
    <li><a href="../../05-internals/development/build-process.html#building-docker-images" class="header">Building Docker Images</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<!---
Copyright © 2015-2018 the contributors (see Contributors.md).

This file is part of Knora.

Knora is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Knora is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with Knora.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1><a href="#build-process" name="build-process" class="anchor"><span class="anchor-link"></span></a>Build Process</h1>
<div class="toc ">
<ul>
  <li><a href="../../05-internals/development/build-process.html#sbt-build-configuration" class="header">SBT Build Configuration</a></li>
  <li><a href="../../05-internals/development/build-process.html#building-deployment-packages" class="header">Building Deployment Packages</a></li>
  <li><a href="../../05-internals/development/build-process.html#building-docker-images" class="header">Building Docker Images</a></li>
</ul>
</div>
<h2><a href="#sbt-build-configuration" name="sbt-build-configuration" class="anchor"><span class="anchor-link"></span></a>SBT Build Configuration</h2>
<p>Knora&rsquo;s complete build definition is defined in <code>KnoraBuild.sbt</code>:</p>
<pre class="prettyprint"><code class="language-sbt"><br/>import com.typesafe.sbt.SbtNativePackager.autoImport.NativePackagerHelper._
import com.typesafe.sbt.packager.docker.DockerPlugin.autoImport.{Docker, dockerRepository}
import com.typesafe.sbt.packager.docker.{Cmd, ExecCmd}
import org.knora.Dependencies

//////////////////////////////////////
// GLOBAL SETTINGS
//////////////////////////////////////

lazy val aggregatedProjects: Seq[ProjectReference] = Seq(docs, salsah1, webapi)

lazy val buildSettings = Dependencies.Versions ++ Seq(
    organization := &quot;org.knora&quot;,
    version := (ThisBuild / version).value
)

lazy val root = Project(id = &quot;knora&quot;, file(&quot;.&quot;))
        .aggregate(aggregatedProjects: _*)
        .enablePlugins(DockerComposePlugin)
        .settings(Dependencies.Versions)
        .settings(
            // values set for all sub-projects
            // These are normal sbt settings to configure for release, skip if already defined

            ThisBuild / licenses := Seq(&quot;AGPL-3.0&quot; -&gt; url(&quot;https://opensource.org/licenses/AGPL-3.0&quot;)),
            ThisBuild / homepage := Some(url(&quot;https://github.com/dhlab-basel/Knora&quot;)),
            ThisBuild / scmInfo := Some(ScmInfo(url(&quot;https://github.com/dhlab-basel/Knora&quot;), &quot;scm:git:git@github.com:dhlab-basel/Knora.git&quot;)),

            // override dynver generated version string because docker hub rejects &#39;+&#39; in tags
            ThisBuild / version ~= (_.replace(&#39;+&#39;, &#39;-&#39;)),
            ThisBuild / dynver ~= (_.replace(&#39;+&#39;, &#39;-&#39;)),

            Global / cancelable := true, // use Ctrl-c to stop current task and not quit SBT

            publish / skip := true,

            Dependencies.sysProps := sys.props.toString(),
            Dependencies.sysEnvs := sys.env.toString(),

            ThisBuild / Dependencies.gdbHomePath := sys.env.getOrElse(&quot;KNORA_GDB_HOME&quot;, sys.props(&quot;user.dir&quot;) + &quot;/triplestores/graphdb/home&quot;),
            ThisBuild / Dependencies.gdbLicensePath := sys.env.getOrElse(&quot;KNORA_GDB_LICENSE&quot;, sys.props(&quot;user.dir&quot;) + &quot;/triplestores/graphdb/graphdb.license&quot;),

            variablesForSubstitution := Map(
                &quot;KNORA_GDB_HOME&quot; -&gt; Dependencies.gdbHomePath.value,
                &quot;KNORA_GDB_LICENSE &quot; -&gt; Dependencies.gdbLicensePath.value,
                &quot;KNORA_GDB_IMAGE&quot; -&gt; Dependencies.gdbImage.value,
                &quot;SIPI_VERSION_TAG&quot; -&gt; Dependencies.sipiVersion.value,
                &quot;KNORA_VERSION_TAG&quot; -&gt; version.value
            ),

            dockerImageCreationTask := Seq(
                (salsah1 / Docker / publishLocal).value,
                (webapi / Docker / publishLocal).value
            )
        )


//////////////////////////////////////
// DOCS (./docs)
//////////////////////////////////////

import scala.sys.process._

// Define `Configuration` instances representing our different documentation trees
lazy val ParadoxSite = config(&quot;paradox&quot;)

lazy val docs = knoraModule(&quot;docs&quot;)
        .enablePlugins(JekyllPlugin, ParadoxPlugin, ParadoxSitePlugin, ParadoxMaterialThemePlugin, GhpagesPlugin)
        .configs(
            ParadoxSite
        )
        .settings(
            // Apply default settings to our two custom configuration instances
            ParadoxSitePlugin.paradoxSettings(ParadoxSite),
            ParadoxMaterialThemePlugin.paradoxMaterialThemeGlobalSettings, // paradoxTheme and version
            ParadoxMaterialThemePlugin.paradoxMaterialThemeSettings(ParadoxSite)
        )
        .settings(

            // Ghpages settings
            ghpagesNoJekyll := true,
            git.remoteRepo := &quot;git@github.com:dhlab-basel/Knora.git&quot;,
            excludeFilter in ghpagesCleanSite :=
                    new FileFilter {
                        def accept(f: File) = (ghpagesRepository.value / &quot;CNAME&quot;).getCanonicalPath == f.getCanonicalPath
                    } || &quot;LICENSE.md&quot; || &quot;README.md&quot;,

            // (sbt-site) Customize the source directory
            // sourceDirectory in Jekyll := sourceDirectory.value / &quot;overview&quot;,
            sourceDirectory in ParadoxSite := sourceDirectory.value / &quot;paradox&quot;,

            // (sbt-site) Customize the output directory (subdirectory of site)
            siteSubdirName in ParadoxSite := &quot;paradox&quot;,

            // Set some paradox properties
            paradoxProperties in ParadoxSite ++= Map(
                &quot;project.name&quot; -&gt; &quot;Knora Documentation&quot;,
                &quot;github.base_url&quot; -&gt; &quot;https://github.com/dhlab-basel/Knora&quot;,
                &quot;image.base_url&quot; -&gt; &quot;.../assets/images&quot;,
                &quot;extref.rfc.base_url&quot; -&gt; &quot;http://tools.ietf.org/html/rfc%s&quot;
            ),

            // Paradox Material Theme Settings
            paradoxMaterialTheme in ParadoxSite ~= {
                _.withColor(&quot;blue&quot;, &quot;yellow&quot;)
                        .withRepository(uri(&quot;https://github.com/dhlab-basel/Knora/docs&quot;))
                        .withFavicon(&quot;cloud&quot;)
                        .withLogoIcon(&quot;cloud&quot;)
                        .withSocial(
                            uri(&quot;https://github.com/dhlab-basel&quot;),
                            uri(&quot;https://twitter.com/dhlabbasel&quot;)
                        )
                        .withLanguage(java.util.Locale.ENGLISH)
                        .withCopyright(&quot;Copyright 2015-2018 the contributors (see Contributors.md)&quot;)
            },
            mappings in makeSite ++= Seq(
                file(&quot;docs/src/api-admin/index.html&quot;) -&gt; &quot;api-admin/index.html&quot;,
                file(&quot;docs/src/api-admin/swagger.json&quot;) -&gt; &quot;api-admin/swagger.json&quot;
            ),
            makeSite := makeSite.dependsOn(buildPrequisites).value
        )

lazy val buildPrequisites = taskKey[Unit](&quot;Build typescript API documentation and Graphviz diagrams.&quot;)

docs / buildPrequisites := {
    val s: TaskStreams = streams.value

    val execDir: Option[File] = if (sys.props(&quot;user.dir&quot;).endsWith(&quot;docs&quot;)) {
        // running from docs directory, which is fine
        None
    } else {
        // running from project root directory
        Some(new File(sys.props(&quot;user.dir&quot;) + &quot;/docs&quot;))
    }

    val shell: Seq[String] = if (sys.props(&quot;os.name&quot;).contains(&quot;Windows&quot;)) Seq(&quot;cmd&quot;, &quot;/c&quot;) else Seq(&quot;bash&quot;, &quot;-c&quot;)
    val clean: Seq[String] = shell :+ &quot;make clean&quot;
    val jsonformat: Seq[String] = shell :+ &quot;make jsonformat&quot;
    val graphvizfigures: Seq[String] = shell :+ &quot;make graphvizfigures&quot;
    val jsonformattest: Seq[String] = shell :+ &quot;make jsonformattest&quot;

    s.log.info(&quot;building typescript documentation and graphviz diagrams...&quot;)

    if ((Process(clean, execDir) #&amp;&amp; Process(jsonformattest, execDir) #&amp;&amp; Process(jsonformat, execDir) #&amp;&amp; Process(graphvizfigures, execDir) !) == 0) {
        Thread.sleep(500)
        s.log.success(&quot;typescript documentation and graphviz diagrams built successfully&quot;)
    } else {
        throw new IllegalStateException(&quot;typescript documentation and graphviz diagrams failed to build&quot;)
    }
}


//////////////////////////////////////
// SALSAH1 (./salsah1)
//////////////////////////////////////

lazy val salsahCommonSettings = Seq(
    name := &quot;salsah1&quot;
)

lazy val salsah1 = knoraModule(&quot;salsah1&quot;)
        .enablePlugins(JavaAppPackaging, DockerPlugin, DockerComposePlugin)
        .configs(
            HeadlessTest
        )
        .settings(
            salsahCommonSettings,
            Revolver.settings
        )
        .settings(inConfig(HeadlessTest)(
            Defaults.testTasks ++ Seq(
                fork := true,
                javaOptions ++= javaHeadlessTestOptions,
                testOptions += Tests.Argument(&quot;-oDF&quot;) // show full stack traces and test case durations
            )
        ): _*)
        .settings(
            Dependencies.salsahLibraryDependencies,
            logLevel := Level.Info,
            fork in run := true,
            javaOptions in run ++= javaRunOptions,
            mainClass in(Compile, run) := Some(&quot;org.knora.salsah.Main&quot;),
            fork in Test := true,
            javaOptions in Test ++= javaTestOptions,
            parallelExecution in Test := false,
            /* show full stack traces and test case durations */
            testOptions in Test += Tests.Argument(&quot;-oDF&quot;)
        )
        .settings( // enable deployment staging with `sbt stage`
            mappings in Universal ++= {
                // copy the public folder
                directory(&quot;salsah1/src/public&quot;) ++
                // copy the configuration files to config directory
                contentOf(&quot;salsah1/configs&quot;).toMap.mapValues(&quot;config/&quot; + _) ++
                // copy configuration files to config directory
                contentOf(&quot;salsah1/src/main/resources&quot;).toMap.mapValues(&quot;config/&quot; + _)
            },
            // add &#39;config&#39; directory first in the classpath of the start script,
            scriptClasspath := Seq(&quot;../config/&quot;) ++ scriptClasspath.value,
            // need this here, but why?
            mainClass in Compile := Some(&quot;org.knora.salsah.Main&quot;),

            // add dockerCommands used to create the image
            // docker:stage, docker:publishLocal, docker:publish, docker:clean

            dockerRepository := Some(&quot;dhlabbasel&quot;),

            maintainer := &quot;ivan.subotic@unibas.ch&quot;,

            Docker / dockerCommands := Seq(
                Cmd(&quot;FROM&quot;, &quot;openjdk:10-jre-slim-sid&quot;),
                Cmd(&quot;LABEL&quot;, s&quot;&quot;&quot;MAINTAINER=&quot;${maintainer.value}&quot;&quot;&quot;&quot;),

                Cmd(&quot;ENV&quot;, &quot;&quot;&quot;LANG=&quot;en_US.UTF-8&quot;&quot;&quot;&quot;),
                Cmd(&quot;ENV&quot;, &quot;&quot;&quot;JAVA_OPTS=&quot;-Dsun.jnu.encoding=UTF-8 -Dfile.encoding=UTF-8&quot;&quot;&quot;&quot;),
                Cmd(&quot;ENV&quot;, &quot;KNORA_SALSAH1_DEPLOYED=true&quot;),
                Cmd(&quot;ENV&quot;, &quot;KNORA_SALSAH1_WORKDIR=/salsah&quot;),

                Cmd(&quot;ADD&quot;, &quot;opt/docker&quot;, &quot;/salsah&quot;),
                Cmd(&quot;WORKDIR&quot;, &quot;/salsah&quot;),

                Cmd(&quot;EXPOSE&quot;, &quot;3335&quot;),

                ExecCmd(&quot;ENTRYPOINT&quot;, &quot;bin/salsah1&quot;),
            ),


        )
        .settings()

lazy val javaRunOptions = Seq(
    // &quot;-showversion&quot;,
    &quot;-Xms256m&quot;,
    &quot;-Xmx256m&quot;
    // &quot;-verbose:gc&quot;,
    //&quot;-XX:+UseG1GC&quot;,
    //&quot;-XX:MaxGCPauseMillis=500&quot;
)

lazy val javaTestOptions = Seq(
    // &quot;-showversion&quot;,
    &quot;-Xms512m&quot;,
    &quot;-Xmx512m&quot;
    // &quot;-verbose:gc&quot;,
    //&quot;-XX:+UseG1GC&quot;,
    //&quot;-XX:MaxGCPauseMillis=500&quot;,
    //&quot;-XX:MaxMetaspaceSize=4096m&quot;
)


lazy val HeadlessTest = config(&quot;headless&quot;) extend (Test)
lazy val javaHeadlessTestOptions = Seq(
    &quot;-Dconfig.resource=headless-testing.conf&quot;
) ++ javaTestOptions



//////////////////////////////////////
// WEBAPI (./webapi)
//////////////////////////////////////

import com.typesafe.sbt.SbtNativePackager.autoImport.NativePackagerHelper._
import sbt._
import sbt.librarymanagement.Resolver

connectInput in run := true

lazy val webApiCommonSettings = Seq(
    name := &quot;webapi&quot;
)

// custom test and it settings
lazy val GDBSE = config(&quot;gdbse&quot;) extend Test
lazy val GDBSEIt = config(&quot;gdbse-it&quot;) extend IntegrationTest
lazy val GDBFree = config(&quot;gdbfree&quot;) extend Test
lazy val GDBFreeIt = config(&quot;gdbfree-it&quot;) extend IntegrationTest
lazy val FusekiTest = config(&quot;fuseki&quot;) extend Test
lazy val FusekiIt = config(&quot;fuseki-it&quot;) extend IntegrationTest
lazy val EmbeddedJenaTDBTest = config(&quot;tdb&quot;) extend Test

// GatlingPlugin - load testing
// JavaAgent - adds AspectJ Weaver configuration
// BuildInfoPlugin - allows generation of scala code with version information

lazy val webapi = knoraModule(&quot;webapi&quot;)
        .enablePlugins(SbtTwirl, JavaAppPackaging, DockerPlugin, GatlingPlugin, JavaAgent, RevolverPlugin, BuildInfoPlugin)
        .configs(
            IntegrationTest,
            Gatling,
            GatlingIt,
            GDBSE,
            GDBSEIt,
            GDBFree,
            GDBFreeIt,
            FusekiTest,
            FusekiIt,
            EmbeddedJenaTDBTest
        )
        .settings(
            webApiCommonSettings,
            resolvers ++= Seq(
                Resolver.bintrayRepo(&quot;hseeberger&quot;, &quot;maven&quot;)
            ),
            Dependencies.webapiLibraryDependencies
        )
        .settings(
            inConfig(Test)(Defaults.testTasks ++ baseAssemblySettings),
            inConfig(IntegrationTest)(Defaults.testSettings),
            inConfig(Gatling)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value)),
            inConfig(GatlingIt)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value)),
            inConfig(GDBSE)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value)),
            inConfig(GDBSEIt)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value)),
            inConfig(GDBFree)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value)),
            inConfig(GDBFreeIt)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value)),
            inConfig(FusekiTest)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value)),
            inConfig(FusekiIt)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value)),
            inConfig(EmbeddedJenaTDBTest)(Defaults.testTasks ++ Seq(forkOptions := Defaults.forkOptionsTask.value))
        )
        .settings(
            scalacOptions ++= Seq(&quot;-feature&quot;, &quot;-unchecked&quot;, &quot;-deprecation&quot;, &quot;-Yresolve-term-conflict:package&quot;),

            logLevel := Level.Info,

            fork := true, // always fork

            run / javaOptions := webapiJavaRunOptions,

            reStart / javaOptions ++= resolvedJavaAgents.value map { resolved =&gt;
                &quot;-javaagent:&quot; + resolved.artifact.absolutePath + resolved.agent.arguments
            }, // allows sbt-javaagent to work with sbt-revolver
            reStart / javaOptions ++= webapiJavaRunOptions,

            javaAgents += Dependencies.Compile.aspectJWeaver,

            Test / parallelExecution := false,
            Test / javaOptions ++= Seq(&quot;-Dconfig.resource=graphdb-se.conf&quot;) ++ webapiJavaTestOptions,
            // Test / javaOptions ++= Seq(&quot;-Dakka.log-config-on-start=on&quot;), // prints out akka config
            // Test / javaOptions ++= Seq(&quot;-Dconfig.trace=loads&quot;), // prints out config locations
            Test / testOptions += Tests.Argument(&quot;-oDF&quot;), // show full stack traces and test case durations

            IntegrationTest / javaOptions := Seq(&quot;-Dconfig.resource=graphdb-se.conf&quot;) ++ webapiJavaTestOptions,
            IntegrationTest / testOptions += Tests.Argument(&quot;-oDF&quot;), // show full stack traces and test case durations

            Gatling / javaOptions := Seq(&quot;-Dconfig.resource=graphdb-se.conf&quot;) ++ webapiJavaTestOptions,
            Gatling / testOptions := Seq(),
            GatlingIt / javaOptions := Seq(&quot;-Dconfig.resource=graphdb-se.conf&quot;) ++ webapiJavaTestOptions,
            GatlingIt / testOptions := Seq(),

            GDBSE / javaOptions := Seq(&quot;-Dconfig.resource=graphdb-se.conf&quot;) ++ webapiJavaTestOptions,
            GDBSEIt / javaOptions := Seq(&quot;-Dconfig.resource=graphdb-se.conf&quot;) ++ webapiJavaTestOptions,

            GDBFree / javaOptions := Seq(&quot;-Dconfig.resource=graphdb-free.conf&quot;) ++ webapiJavaTestOptions,
            GDBFreeIt / javaOptions := Seq(&quot;-Dconfig.resource=graphdb-free.conf&quot;) ++ webapiJavaTestOptions,

            FusekiTest / javaOptions := Seq(&quot;-Dconfig.resource=fuseki.conf&quot;) ++ webapiJavaTestOptions,
            FusekiIt / javaOptions := Seq(&quot;-Dconfig.resource=fuseki.conf&quot;) ++ webapiJavaTestOptions,

            EmbeddedJenaTDBTest / javaOptions := Seq(&quot;-Dconfig.resource=jenatdb.conf&quot;) ++ webapiJavaTestOptions,

            // enable publishing the jar produced by `sbt test:package` and `sbt it:package`
            Test / packageBin / publishArtifact := true,
            IntegrationTest / packageBin / publishArtifact := true
        )
        .settings(
            // prepare for publishing

            // Skip packageDoc task on stage
            Compile / packageDoc / mappings := Seq(),

            Universal / mappings ++= {
                // copy the scripts folder
                directory(&quot;webapi/scripts&quot;) ++
                        // copy the configuration files to config directory
                        contentOf(&quot;webapi/configs&quot;).toMap.mapValues(&quot;config/&quot; + _) ++
                        // copy configuration files to config directory
                        contentOf(&quot;webapi/src/main/resources&quot;).toMap.mapValues(&quot;config/&quot; + _)
                // copy the aspectj weaver jar
                // contentOf(&quot;vendor&quot;).toMap.mapValues(&quot;aspectjweaver/&quot; + _)
            },

            // add &#39;config&#39; directory to the classpath of the start script,
            Universal / scriptClasspath := Seq(&quot;../config/&quot;) ++ scriptClasspath.value,

            // need this here, so that the Manifest inside the jars has the correct main class set.
            Compile / mainClass := Some(&quot;org.knora.webapi.Main&quot;),
            Compile / run / mainClass := Some(&quot;org.knora.webapi.Main&quot;),
            Test / mainClass := Some(&quot;org.scalatest.tools.Runner&quot;),
            IntegrationTest / mainClass := Some(&quot;org.scalatest.tools.Runner&quot;),

            // add dockerCommands used to create the image
            // docker:stage, docker:publishLocal, docker:publish, docker:clean

            dockerRepository := Some(&quot;dhlabbasel&quot;),

            maintainer := &quot;ivan.subotic@unibas.ch&quot;,

            Docker / dockerCommands := Seq(
                Cmd(&quot;FROM&quot;, &quot;openjdk:10-jre-slim-sid&quot;),
                Cmd(&quot;LABEL&quot;, s&quot;&quot;&quot;MAINTAINER=&quot;${maintainer.value}&quot;&quot;&quot;&quot;),
                // install wget
                Cmd(&quot;RUN&quot;, &quot;apt-get -qq update &amp;&amp; apt-get install -y --no-install-recommends wget=1.19.5-2 &amp;&amp; rm -rf /var/lib/apt/lists/*&quot;),
                // install yourkit profiler
                Cmd(&quot;RUN&quot;, &quot;wget https://www.yourkit.com/download/docker/YourKit-JavaProfiler-2018.04-docker.zip -P /tmp/ &amp;&amp; unzip /tmp/YourKit-JavaProfiler-2018.04-docker.zip -d /usr/local &amp;&amp; rm /tmp/YourKit-JavaProfiler-2018.04-docker.zip&quot;),

                Cmd(&quot;ADD&quot;, &quot;opt/docker&quot;, &quot;/webapi&quot;),
                Cmd(&quot;WORKDIR&quot;, &quot;/webapi&quot;),

                Cmd(&quot;EXPOSE&quot;, &quot;3333&quot;),
                Cmd(&quot;EXPOSE&quot;, &quot;10001&quot;),

                ExecCmd(&quot;ENTRYPOINT&quot;, &quot;bin/webapi&quot;, &quot;-J-agentpath:/usr/local/YourKit-JavaProfiler-2018.04/bin/linux-x86-64/libyjpagent.so=port=10001,listen=all&quot;),
            )
        )
        .settings(
            buildInfoKeys ++= Seq[BuildInfoKey](
                name,
                version,
                &quot;akkaHttp&quot; -&gt; Dependencies.akkaHttpVersion
            ),
            buildInfoPackage := &quot;org.knora.webapi&quot;
        )

lazy val webapiJavaRunOptions = Seq(
    // &quot;-showversion&quot;,
    &quot;-Xms1G&quot;,
    &quot;-Xmx1G&quot;,
    // &quot;-verbose:gc&quot;,
    //&quot;-XX:+UseG1GC&quot;,
    //&quot;-XX:MaxGCPauseMillis=500&quot;
    &quot;-Dcom.sun.management.jmxremote&quot;,
    &quot;-Dcom.sun.management.jmxremote.port=1617&quot;,
    &quot;-Dcom.sun.management.jmxremote.authenticate=false&quot;,
    &quot;-Dcom.sun.management.jmxremote.ssl=false&quot;,
    //&quot;-agentpath:/Applications/YourKit-Java-Profiler-2018.04.app/Contents/Resources/bin/mac/libyjpagent.jnilib&quot;
)

lazy val webapiJavaTestOptions = Seq(
    // &quot;-showversion&quot;,
    &quot;-Xms1G&quot;,
    &quot;-Xmx1G&quot;
    // &quot;-verbose:gc&quot;,
    //&quot;-XX:+UseG1GC&quot;,
    //&quot;-XX:MaxGCPauseMillis=500&quot;,
    //&quot;-XX:MaxMetaspaceSize=4096m&quot;
)

def knoraModule(name: String): Project =
    Project(id = name, base = file(name))
            .settings(buildSettings)</code></pre>
<h2><a href="#building-deployment-packages" name="building-deployment-packages" class="anchor"><span class="anchor-link"></span></a>Building Deployment Packages</h2>
<p>Deployment packages for <code>salsah1</code> and <code>webapi</code> can be built by using the following SBT tasks:</p>
<ul>
  <li><code>$ sbt stage</code> - Stages the app so that it can be run locally without having the app packaged.</li>
  <li><code>$ sbt universal:packageBin</code> - Generates a universal zip file</li>
  <li><code>$ sbt universal:packageZipTarball</code> - Generates a universal tgz file</li>
</ul>
<p>The tasks can be scoped by prefixing <code>salsah1/</code> or <code>webapi/</code>, e.g., to only run <code>sbt stage</code> for the <code>webapi</code> project, run:</p>
<pre class="prettyprint"><code class="language-bash">$ sbt webapi/stage
</code></pre>
<h2><a href="#building-docker-images" name="building-docker-images" class="anchor"><span class="anchor-link"></span></a>Building Docker Images</h2>
<p>Docker images for <code>salsah1</code> and <code>webapi</code> can be built by using the following SBT tasks:</p>
<ul>
  <li><code>$ sbt docker:stage</code> - Generates a directory with the Dockerfile and environment prepared for creating a Docker image.</li>
  <li><code>$ sbt docker:publishLocal</code> - Builds an image using the local Docker server.</li>
  <li><code>$ sbt docker:publish</code> - Builds an image using the local Docker server, and pushes it to the configured remote repository.</li>
  <li><code>$ sbt docker:clean</code> - Removes the built image from the local Docker server.</li>
</ul>
<p>The tasks can be scoped by prefixing <code>salsah1/</code> or <code>webapi/</code>, e.g., to only run <code>sbt docker:stage</code> for the <code>webapi</code> project, run:</p>
<pre class="prettyprint"><code class="language-bash">$ sbt webapi/docker:stage
```` 

## Running the Knora Stack (graphdb, webapi, salsah1, sipi)

The complete knora stack (graphdb, webapi, salsah1, sipi) can be started by invoking the following SBT task:

</code></pre>
<p>$ sbt dockerComposeUp</p>
<pre><code><br/>This will build, publish locally and use the docker images for `webapi` and `salsah1`.


## Building Documentation

The complete Knora documentation site is built by invoking the following tasks:

- `$ sbt docs/makeSite` - generates the documentation which can be found under `docs/target/site/`
- `$ sbt docs/previewSite` - previews the generated site by launching a static web server
- `$ sbt docs/previewAuto` - previews the generated site by launching a dynamic server updating its content at each modification in your source files.

Both preview tasks launch the server on port `4000` and attempt to connect your browser to `http://localhost:4000/`.


## Publishing Documentation

To publish the documentation, you need to be on the `develop` branch and then execute the following task:

</code></pre>
<p>$ sbt docs/ghpagesPushSite ```</p>
<p>This task will build all documentation and publish it to the <code>gh-pages</code> branch.</p>
</div>
<div>
<a href="https://github.com/dhlab-basel/Knora/tree/master/docs/src/paradox/05-internals/development/build-process.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
3.0.0-0-d71e52b7-20181130-1525
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../05-internals/development/building-and-running.html" title="Building and Running" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Building and Running
</span>
</div>
</a>
<a href="../../05-internals/development/intellij-config.html" title="Setup IntelliJ for development of Knora" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Setup IntelliJ for development of Knora
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright 2015-2018 the contributors (see Contributors.md)
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/dhlab-basel" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/dhlabbasel" class="md-footer-social__link fa fa-twitter"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../../assets/javascripts/application.5165553b.js"></script>
<script src="../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../."}})</script>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
