<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../cloud">
<title>Interaction Between Sipi and Knora · Knora Documentation</title>
<link rel="stylesheet" href="../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../assets/stylesheets/application-palette.792431c1.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
data-md-color-primary="blue"
data-md-color-accent="yellow"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Knora Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">cloud</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Knora Documentation
</span>
<span class="md-header-nav__topic">
Interaction Between Sipi and Knora
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">cloud</i>
</span>
<a href="../index.html" title="Knora Documentation">
Knora Documentation
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
<ul>
  <li><a href="../01-introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../01-introduction/what-is-knora.html" class="page">What Is Knora?</a></li>
    <li><a href="../01-introduction/data-formats.html" class="page">Data Formats in Knora</a></li>
    <li><a href="../01-introduction/standoff-rdf.html" class="page">Standoff/RDF Text Markup</a></li>
    <li><a href="../01-introduction/example-project.html" class="page">An Example Project</a></li>
  </ul></li>
  <li><a href="../02-knora-ontologies/index.html" class="page">Knora Ontologies</a>
  <ul>
    <li><a href="../02-knora-ontologies/introduction.html" class="page">Introduction</a></li>
    <li><a href="../02-knora-ontologies/knora-base.html" class="page">The Knora Base Ontology</a></li>
    <li><a href="../02-knora-ontologies/salsah-gui.html" class="page">The SALSAH GUI Ontology</a></li>
  </ul></li>
  <li><a href="../03-apis/index.html" class="page">The Knora APIs</a>
  <ul>
    <li><a href="../03-apis/api-v1/index.html" class="page">Knora API v1</a></li>
    <li><a href="../03-apis/api-v2/index.html" class="page">Knora API v2</a></li>
    <li><a href="../03-apis/api-admin/index.html" class="page">Knora Admin API</a></li>
  </ul></li>
  <li><a href="../04-deployment/index.html" class="page">Deploying Knora</a>
  <ul>
    <li><a href="../04-deployment/getting-started.html" class="page">Getting Started with Knora</a></li>
    <li><a href="../04-deployment/configuration.html" class="page">Configuration</a></li>
  </ul></li>
  <li><a href="../05-internals/index.html" class="page">Knora Internals</a>
  <ul>
    <li><a href="../05-internals/design/index.html" class="page">Design</a></li>
    <li><a href="../05-internals/development/index.html" class="page">Development</a></li>
  </ul></li>
  <li><a href="../06-salsah/index.html" class="page">The SALSAH 1 GUI</a></li>
  <li><a href="../07-sipi/index.html" class="page">The Sipi Media Server</a>
  <ul>
    <li><a href="../07-sipi/setup-sipi-for-knora.html" class="page">Setting Up Sipi for Knora</a></li>
    <li><a href="../07-sipi/sipi-and-knora.html" class="active page">Interaction Between Sipi and Knora</a></li>
  </ul></li>
  <li><a href="../faq.html" class="page">Frequently Asked Questions</a></li>
  <li><a href="../00-release-notes/index.html" class="page">Release Notes</a>
  <ul>
    <li><a href="../00-release-notes/v1.1.0.html" class="page">v1.1.0 Release Notes</a></li>
    <li><a href="../00-release-notes/v1.2.0.html" class="page">v1.2.0 Release Notes</a></li>
    <li><a href="../00-release-notes/v1.3.0.html" class="page">v1.3.0 Release Notes</a></li>
    <li><a href="../00-release-notes/v1.4.0.html" class="page">v1.4.0 Release Notes</a></li>
    <li><a href="../00-release-notes/v1.5.0.html" class="page">v1.5.0 Release Notes</a></li>
    <li><a href="../00-release-notes/v1.6.0.html" class="page">v1.6.0 Release Notes</a></li>
    <li><a href="../00-release-notes/v1.7.0.html" class="page">v1.7.x Release Notes</a></li>
    <li><a href="../00-release-notes/v2.x.x.html" class="page">v2.x.x Release Notes</a></li>
    <li><a href="../00-release-notes/v3.x.x.html" class="page">v3.x.x Release Notes</a></li>
    <li><a href="../00-release-notes/v4.x.x.html" class="page">v4.x.x Release Notes</a></li>
    <li><a href="../00-release-notes/v5.x.x.html" class="page">v5.x.x Release Notes</a></li>
    <li><a href="../00-release-notes/v6.x.x.html" class="page">v6.x.x Release Notes</a></li>
    <li><a href="../00-release-notes/next.html" class="page">Release Notes for Next Release</a></li>
    <li><a href="../00-release-notes/migration.html" class="page">Migration Notes</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../07-sipi/sipi-and-knora.html#interaction-between-sipi-and-knora" class="header">Interaction Between Sipi and Knora</a>
  <ul>
    <li><a href="../07-sipi/sipi-and-knora.html#general-remarks" class="header">General Remarks</a></li>
    <li><a href="../07-sipi/sipi-and-knora.html#adding-files-to-knora-using-the-gui-or-directly-the-api" class="header">Adding Files to Knora: Using the GUI or directly the API</a></li>
    <li><a href="../07-sipi/sipi-and-knora.html#retrieving-files-from-sipi" class="header">Retrieving Files from Sipi</a></li>
    <li><a href="../07-sipi/sipi-and-knora.html#authentication-of-users-with-sipi" class="header">Authentication of users with Sipi</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 7.0.0-10-002eca45-20190603-0947
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../07-sipi/sipi-and-knora.html#interaction-between-sipi-and-knora" class="header">Interaction Between Sipi and Knora</a>
  <ul>
    <li><a href="../07-sipi/sipi-and-knora.html#general-remarks" class="header">General Remarks</a></li>
    <li><a href="../07-sipi/sipi-and-knora.html#adding-files-to-knora-using-the-gui-or-directly-the-api" class="header">Adding Files to Knora: Using the GUI or directly the API</a></li>
    <li><a href="../07-sipi/sipi-and-knora.html#retrieving-files-from-sipi" class="header">Retrieving Files from Sipi</a></li>
    <li><a href="../07-sipi/sipi-and-knora.html#authentication-of-users-with-sipi" class="header">Authentication of users with Sipi</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<!---
Copyright © 2015-2019 the contributors (see Contributors.md).

This file is part of Knora.

Knora is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Knora is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with Knora.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1><a href="#interaction-between-sipi-and-knora" name="interaction-between-sipi-and-knora" class="anchor"><span class="anchor-link"></span></a>Interaction Between Sipi and Knora</h1>
<p>TODO: reorganise this to make clear that it describes Knora API v1.</p>
<h2><a href="#general-remarks" name="general-remarks" class="anchor"><span class="anchor-link"></span></a>General Remarks</h2>
<p>Knora and Sipi (Simple Image Presentation Interface) are two <strong>complementary</strong> software projects. Whereas Knora deals with data that is written to and read from a triplestore (metadata and annotations), Sipi takes care of storing, converting and serving image files as well as other types of files such as audio, video, or documents (binary files it just stores and serves).</p>
<p>Knora and Sipi stick to a clear division of responsibility regarding files: Knora knows about the names of files that are attached to resources as well as some metadata and is capable of creating the URLs for the client to request them from Sipi, but the whole handling of files (storing, naming, organization of the internal directory structure, format conversions, and serving) is taken care of by Sipi.</p>
<h2><a href="#adding-files-to-knora-using-the-gui-or-directly-the-api" name="adding-files-to-knora-using-the-gui-or-directly-the-api" class="anchor"><span class="anchor-link"></span></a>Adding Files to Knora: Using the GUI or directly the API</h2>
<p>To create a resource with a digital representation attached to, either the browser-based GUI (SALSAH) can be used or this can be done by <em>directly</em> addressing the API. (Of course, also the GUI uses the API. But the user does not need to know about it.) The same applies for changing an existing digital representation for a resource. Subsequently, the first case will be called the <em>GUI case</em> and the second the <em>non-GUI case</em>.</p>
<h3><a href="#gui-case" name="gui-case" class="anchor"><span class="anchor-link"></span></a>GUI Case</h3>
<p>In this case, the user may choose a file to upload using his web-browser. The file is directly sent to Sipi (route: <code>create_thumbnail</code>) to calculate a thumbnail hosted by Sipi which then gets displayed to the user in the browser. Sipi copies the original file into a temporary directory and keeps it there (for later processing in another request). In its answer (JSON), Sipi returns:</p>
<ul>
  <li><code>preview_path</code>: the path to the thumbnail (accessible to a  web-browser)</li>
  <li><code>filename</code>: the name of the temporarily stored original file  (managed by Sipi)</li>
  <li><code>original_mimetype</code>: mime type of the original file</li>
  <li><code>original_filename</code>: the original name of the file submitted by  the client</li>
</ul>
<p>Once the user finally wants to attach the file to a resource, the request is sent to Knora&rsquo;s API providing all the required parameters to create the resource along with additional information about the file to be attached. <strong>However, the file itself is not submitted to the Knora Api, but its filename returned by Sipi (from the <code>create_thumbnail</code> response).</strong></p>
<h4><a href="#create-a-new-resource-with-a-digital-representation" name="create-a-new-resource-with-a-digital-representation" class="anchor"><span class="anchor-link"></span></a>Create a new Resource with a Digital Representation</h4>
<p>The POST request is handled in <code>ResourcesRouteV1.scala</code> and parsed to a <code>CreateResourceApiRequestV1</code>. Information about the file is sent separately from the other resource parameters (properties) under the name <code>file</code>:</p>
<ul>
  <li><code>originalFilename</code>: original name of the file (returned by Sipi  when creating the thumbnail)</li>
  <li><code>originalMimeType</code>: original mime type of the file (returned by  Sipi when creating the thumbnail)</li>
  <li><code>filename</code>: name of the temporarily stored original file (returned  by Sipi when creating the thumbnail)</li>
</ul>
<p>In the route, a <code>SipiResponderConversionFileRequestV1</code> is created representing the information about the file to be attached to the new resource. Along with the other parameters, it is sent to the resources responder.</p>
<p>See <a href="sipi-and-knora.html#further-handling-of-the-gui-and-the-non-gui-case-in-the-resources-responder">Further Handling of the GUI and the non GUI-case in the Resources Responder</a> for details of how the resources responder then handles the request.</p>
<h4><a href="#change-the-digital-representation-of-a-resource" name="change-the-digital-representation-of-a-resource" class="anchor"><span class="anchor-link"></span></a>Change the Digital Representation of a Resource</h4>
<p>The request is taken care of in <code>ValuesRouteV1.scala</code>. The PUT request is handled in path <code>v1/filevalue/{resIri}</code> which receives the resource Iri as a part of the URL: <em>The submitted file will update the existing file values of the given resource.</em></p>
<p>The file parameters are submitted as json and are parsed into a <code>ChangeFileValueApiRequestV1</code>. To represent the conversion request for the Sipi responder, a <code>SipiResponderConversionFileRequestV1</code> is created. A <code>ChangeFileValueRequestV1</code> containing the resource Iri and the message for Sipi is then created and sent to the values responder.</p>
<p>See <a href="sipi-and-knora.html#further-handling-of-the-gui-and-the-non-gui-case-in-the-values-responder">Further Handling of the GUI and the non GUI-case in the Values Responder</a> for details of how the values responder then handles the request.</p>
<h3><a href="#non-gui-case" name="non-gui-case" class="anchor"><span class="anchor-link"></span></a>Non-GUI case</h3>
<p>In this case, the API receives an HTTP multipart request containing the binary data.</p>
<h4><a href="#create-a-new-resource-with-a-digital-representation" name="create-a-new-resource-with-a-digital-representation" class="anchor"><span class="anchor-link"></span></a>Create a new Resource with a Digital Representation</h4>
<p>The request is handled in <code>ResourcesRouteV1.scala</code>. The multipart POST request consists of two named body parts: <code>json</code> containing the resource parameters (properties) and <code>file</code> containing the binary data as well as the file name and its mime type. Using Python&rsquo;s <a href="http://docs.python-requests.org/en/master/user/quickstart/#post-a-multipart-encoded-file">request module</a>, a request could look like this:</p>
<pre class="prettyprint"><code class="language-python">import requests, json

params = {...} // resource parameters
files = {&#39;file&#39;: (filename, open(path + filename, &#39;rb&#39;), mimetype)} // filename, binary data, and mime type

r = requests.post(knora_url + &#39;/resources&#39;,
                  data={&#39;json&#39;: json.dumps(params)},
                  files=files,
                  headers=None)
</code></pre>
<p>The binary data is saved to a temporary location by Knora. The route then creates a <code>SipiResponderConversionPathRequestV1</code> representing the information about the file (i.e. the temporary path to the file) to be attached to the new resource. Along with the other parameters, it is sent to the resources responder.</p>
<p>See <a href="sipi-and-knora.html#further-handling-of-the-gui-and-the-non-gui-case-in-the-resources-responder">Further Handling of the GUI and the non GUI-case in the Resources Responder</a> for details of how the resources responder then handles the request.</p>
<h4><a href="#change-the-digital-representation-of-a-resource" name="change-the-digital-representation-of-a-resource" class="anchor"><span class="anchor-link"></span></a>Change the Digital Representation of a Resource</h4>
<p>The request is taken care of in <code>ValuesRouteV1.scala</code>. The multipart PUT request is handled in path <code>v1/filevalue/{resIri}</code> which receives the resource Iri as a part of the URL: <em>The submitted file will update the existing file values of the given resource.</em></p>
<p>For the request, no json parameters are required. So its body just consists of the binary data (see <a href="sipi-and-knora.html#create-a-new-resource-with-a-digital-representation">Create a new Resource with a Digital Representation</a>). The values route stores the submitted binaries as a temporary file and creates a <code>SipiResponderConversionPathRequestV1</code>. A <code>ChangeFileValueRequestV1</code> containing the resource Iri and the message for Sipi is then created and sent to the values responder.</p>
<p>See <a href="sipi-and-knora.html#further-handling-of-the-gui-and-the-non-gui-case-in-the-values-responder">Further Handling of the GUI and the non GUI-case in the Values Responder</a> for details of how the values responder then handles the request.</p>
<h3><a href="#further-handling-of-the-gui-and-the-non-gui-case-in-the-resources-responder" name="further-handling-of-the-gui-and-the-non-gui-case-in-the-resources-responder" class="anchor"><span class="anchor-link"></span></a>Further Handling of the GUI and the Non-GUI case in the Resources Responder</h3>
<p>Once a <code>SipiResponderConversionFileRequestV1</code> (GUI case) or a <code>SipiResponderConversionPathRequestV1</code> (non-GUI case) has been created and passed to the resources responder, the GUI and the non-GUI case can be handled in a very similar way. This is why they are both implementations of the trait <code>SipiResponderConversionRequestV1</code>.</p>
<p>The resource responder calls the ontology responder to check if all required properties were submitted for the given resource type. Also it is checked if the given resource type may have a digital representation. The resources responder then sends a message to Sipi responder that does a request to the Sipi server. Depending on the type of the message (<code>SipiResponderConversionFileRequestV1</code> or <code>SipiResponderConversionPathRequestV1</code>), a different Sipi route is called. In the first case (GUI case), the file is already managed by Sipi and only the filename has to be indicated. In the latter case, Sipi is told about the location where Knora has saved the binary data to.</p>
<p>To make this handling easy for Knora, both messages have their own implementation for creating the parameters for Sipi (declared in the trait as <code>toFormData</code>). If Knora deals with a <code>SipiResponderConversionPathRequestV1</code>, it has to delete the temporary file after it has been processed by SIPI. Here, we assume that we deal with an image.</p>
<p>For both cases, Sipi returns the same answer containing the following information:</p>
<ul>
  <li><code>file_type</code>: the type of the file that has been handled by Sipi  (image | video | audio | text | binary)</li>
  <li><code>mimetype_full</code> and <code>mimetype_thumb</code>: mime types of the full image  representation and the thumbnail</li>
  <li><code>original_mimetype</code>: the mime type of the original file</li>
  <li><code>original_filename</code>: the name of the original file</li>
  <li><code>nx_full</code>, <code>ny_full</code>, <code>nx_thumb</code>, and <code>ny_thumb</code>: the x and y  dimensions of both the full image and the thumbnail</li>
  <li><code>filename_full</code> and <code>filename_full</code>: the names of the full image  and the thumbnail (needed to request the images from Sipi)</li>
</ul>
<p>The <code>file_type</code> is important because representations for resources are restricted to media types: image, audio, video or a generic binary file. If a resource type requires an image representations (subclass of <code>StillImageRepresentation</code>), the <code>file_type</code> has to be an image. Otherwise, the ontology&rsquo;s restrictions would be violated. Because of this requirement, there is a construct <code>fileType2FileValueProperty</code> mapping file types to file value properties. Also all the possible file types are defined in enumeration.</p>
<p>Depending on the given file type, Sipi responder can create the apt message (here: <code>StillImageFileValueV1</code>) to save the data to the triplestore.</p>
<h3><a href="#further-handling-of-the-gui-and-the-non-gui-case-in-the-values-responder" name="further-handling-of-the-gui-and-the-non-gui-case-in-the-values-responder" class="anchor"><span class="anchor-link"></span></a>Further Handling of the GUI and the non-GUI case in the Values Responder</h3>
<p>In the values responder, <code>ChangeFileValueRequestV1</code> is passed to the method <code>changeFileValueV1</code>. Unlike ordinary value change requests, the Iris of the value objects to be updated are not known yet. Because of this, all the existing file values of the given resource Iri have to be queried first. Also their quality levels are queried because in case of a <code>StillImageFileValue</code>, we have to deal with a file value for the thumbnail and another one for the full quality representation. When these two file values are being updated, the quality levels have to be considered for the sake of consistency (otherwise a full quality value&rsquo;s <code>knora-base:previous-value</code> may point to a thumbnail file value).</p>
<p>With the file values being returned, we actually know about the current Iris of the value objects. Now the Sipi responder is called to handle the file conversion request (see <a href="sipi-and-knora.html#further-handling-of-the-gui-and-the-non-gui-case-in-the-resources-responder">Further Handling of the GUI and the non GUI-case in the Resources Responder</a>). After that, it is checked that the <code>file_type</code> returned by Sipi responder corresponds to the property type of the existing file values. For example, if the <code>file_type</code> is an image, the property pointing to the current file values must be a <code>hasStillImageFileValue</code>. Otherwise, the user submitted a non image file that has to be rejected.</p>
<p>Depending on the <code>file_type</code>, messages of type <code>ChangeValueRequestV1</code> can be created. For each existing file value, such a message is instantiated containing the current value Iri and the new value to be created (returned by the sipi responder). These messages are passed to <code>changeValueV1</code> because with the described handling done in <code>changeFileValueV1</code>, the file values can be changed like any other value type.</p>
<p>In case of success, a <code>ChangeFileValueResponseV1</code> is sent back to the client, containing a list of the single <code>ChangeValueResponseV1</code>.</p>
<h2><a href="#retrieving-files-from-sipi" name="retrieving-files-from-sipi" class="anchor"><span class="anchor-link"></span></a>Retrieving Files from Sipi</h2>
<h3><a href="#url-creation" name="url-creation" class="anchor"><span class="anchor-link"></span></a>URL creation</h3>
<p>Binary representions of Knora locations are served by Sipi. For each file value, Knora creates several locations representing different quality levels:</p>
<pre><code>&quot;resinfo&quot;: {
   &quot;locations&quot;: [
      {
         &quot;duration&quot;: ​0,
         &quot;nx&quot;: ​95,
         &quot;path&quot;: &quot;http://sipiserver:port/knora/incunabula_0000000002.jpg/full/full/0/default.jpg&quot;,
         &quot;ny&quot;: ​128,
         &quot;fps&quot;: ​0,
         &quot;format_name&quot;: &quot;JPEG&quot;,
         &quot;origname&quot;: &quot;ad+s167_druck1=0001.tif&quot;,
         &quot;protocol&quot;: &quot;file&quot;
      },
      {
         &quot;duration&quot;: ​0,
          &quot;nx&quot;: ​82,
          &quot;path&quot;: &quot;http://sipiserver:port/knora/incunabula_0000000002.jp2/full/82,110/0/default.jpg&quot;,
          &quot;ny&quot;: ​110,
          &quot;fps&quot;: ​0,
          &quot;format_name&quot;: &quot;JPEG2000&quot;,
          &quot;origname&quot;: &quot;ad+s167_druck1=0001.tif&quot;,
          &quot;protocol&quot;: &quot;file&quot;
      },
      {
          &quot;duration&quot;: ​0,
          &quot;nx&quot;: ​163,
          &quot;path&quot;: &quot;http://sipiserver:port/knora/incunabula_0000000002.jp2/full/163,219/0/default.jpg&quot;,
          &quot;ny&quot;: ​219,
          &quot;fps&quot;: ​0,
          &quot;format_name&quot;: &quot;JPEG2000&quot;,
          &quot;origname&quot;: &quot;ad+s167_druck1=0001.tif&quot;,
          &quot;protocol&quot;: &quot;file&quot;
      }
      ...
   ],
&quot;restype_label&quot;: &quot;Seite&quot;,
&quot;resclass_has_location&quot;: true,
</code></pre>
<p>Each of these paths has to be handled by the browser by making a call to Sipi, obtaining the binary representation in the desired quality. To deal with different image quality levels, Sipi implements the <a href="http://iiif.io/api/image/2.0/">IIIF standard</a>. The different quality level paths are created by Knora in <code>ValueUtilV1</code>.</p>
<p>Whenever Sipi serves a binary representation of a Knora file value (indicated by using the prefix <code>knora</code> in the path), it has to make a request to Knora&rsquo;s Sipi responder to get the user&rsquo;s permissions on the requested file. Sipi&rsquo;s request to Knora contains a cookie with the Knora session id the user has obtained when logging in to Knora: As a response to a successful login, Knora returns the user&rsquo;s session id and this id is automatically sent to Sipi by the browser, setting a second cookie for the communication with Sipi. The reason the Knora session id is set in two cookies, is the fact that cookies can not be shared among different domains. Since Knora and Sipi are likely to be running under different domains, this solution offers the necessary flexibility.</p>
<h2><a href="#authentication-of-users-with-sipi" name="authentication-of-users-with-sipi" class="anchor"><span class="anchor-link"></span></a>Authentication of users with Sipi</h2>
<p>Whenever a file is requested, Sipi asks Knora about the current user&rsquo;s permissions on the given file. This is achieved by sharing the Knora session cookie with Sipi. When the user logs in to Knora using his browser (using either <code>V1</code> or <code>V2</code> authentication route), a session cookie containing a JWT token representing the user is stored in the user&rsquo;s client. This session cookie is then read by Sipi and used to query for the user&rsquo;s image permissions.</p>
<p>For the session cookie to be sent to Sipi, both the Knora API and Sipi endpoints need to be under the same domain, e.g., <code>api.example.com</code> and <code>iiif.example.com</code>.</p>
</div>
<div>
<a href="https://github.com/dhlab-basel/Knora/tree/master/docs/src/paradox/07-sipi/sipi-and-knora.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
7.0.0-10-002eca45-20190603-0947
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../07-sipi/setup-sipi-for-knora.html" title="Setting Up Sipi for Knora" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Setting Up Sipi for Knora
</span>
</div>
</a>
<a href="../faq.html" title="Frequently Asked Questions" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Frequently Asked Questions
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright 2015-2019 the contributors (see Contributors.md)
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/dhlab-basel" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/dhlabbasel" class="md-footer-social__link fa fa-twitter"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.5165553b.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
